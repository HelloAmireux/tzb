"use strict";(function(){"use strict";var getUrlQuery=function getUrlQuery(url,field){var url=url?url:window.location.href,reg,queryString;if(field){reg=new RegExp("[?&]"+field+"=([^&#]*)","i");try{queryString=reg.exec(url)[1]}catch(e){queryString=null}}else{queryString=url.substring(url.indexOf("?")+1)}return queryString};if(qidianMonitor){window.__monitor=new qidianMonitor({projectName:"qidian-wpa",uin:getUrlQuery(location.href,"kfuin"),beforeReport:function beforeReport(log){console.log("beforeReport",log);try{if(log.msg&&log.msg.indexOf("Script error")>-1){return false}if(log.msg&&log.msg.indexOf("chrome-extension://")>-1){return false}}catch(error){console.log("Script error",error)}return true},afterReport:function afterReport(log){},beforeReportSpeed:function beforeReportSpeed(log){return log},beforeRequest:function beforeRequest(log){return log},rumBeforeRequest:function rumBeforeRequest(log){return log}})}function addEvent(elem,eventName,callbackFunction){if(elem.addEventListener){elem.addEventListener(eventName,callbackFunction,false)}else{elem.attachEvent("on"+eventName,callbackFunction)}}var postMsgFilter=function postMsgFilter(postMsg){var regex=/uc_msg|oppo_night|weibo|msfapi|axure/i,_toString=Object.prototype.toString,postMsgUrl;try{postMsgUrl=_toString.call(postMsg)=="[object String]"&&JSON.parse(postMsg).ldpUrl;if(regex.test(postMsgUrl)){return postMsg}}catch(e){console.error("PostMsg Parse Error "+postMsg)}if(!postMsg||_toString.call(postMsg)!=="[object String]"||regex.test(postMsg)){return false}return postMsg};var postMsg=function(){var msgData,flagKey="QD_PM",flagVal="CHAT";function receive(target,cb){addEvent(target,"message",function(e){var postMsg=postMsgFilter(e.data);if(postMsg){try{msgData=JSON.parse(postMsg)}catch(e){console.error("PostMsg Parse Error "+postMsg)}typeof cb=="function"?cb(msgData):""}else{return}})}function send(postMsgData,sendFlagVal){var sendData=msgData?$.extend(msgData,postMsgData):postMsgData;var _flagVal=sendFlagVal||flagVal;if(!sendData.hasOwnProperty(flagKey)||sendData[flagKey]!=_flagVal){sendData[flagKey]=_flagVal}sendData=typeof sendData!="string"?JSON.stringify(sendData):sendData;window.parent.postMessage(sendData,"*")}return{receive:receive,send:send}}();var isOa=/^oa.*/.test(location.host);if(!isOa){try{console.log=function(){};console.info=function(){}}catch(ex){}}function log(){if(window.__domain.chat!="ch"+"at"&&window.console&&window.console.trace&&Object.prototype.toString.apply(window.console.trace)=="[object Function]"){window.console.trace(arguments)}}(function(global){var apple_phone=/iPhone/i,apple_ipod=/iPod/i,apple_tablet=/iPad/i,android_phone=/(?=.*\bAndroid\b)(?=.*\bMobile\b)/i,android_tablet=/Android/i,amazon_phone=/(?=.*\bAndroid\b)(?=.*\bSD4930UR\b)/i,amazon_tablet=/(?=.*\bAndroid\b)(?=.*\b(?:KFOT|KFTT|KFJWI|KFJWA|KFSOWI|KFTHWI|KFTHWA|KFAPWI|KFAPWA|KFARWI|KFASWI|KFSAWI|KFSAWA)\b)/i,windows_phone=/Windows Phone/i,windows_tablet=/(?=.*\bWindows\b)(?=.*\bARM\b)/i,other_blackberry=/BlackBerry/i,other_blackberry_10=/BB10/i,other_opera=/Opera Mini/i,other_chrome=/(CriOS|Chrome)(?=.*\bMobile\b)/i,other_firefox=/(?=.*\bFirefox\b)(?=.*\bMobile\b)/i,seven_inch=new RegExp("(?:"+"Nexus 7"+"|"+"BNTV250"+"|"+"Kindle Fire"+"|"+"Silk"+"|"+"GT-P1000"+")","i");var match=function match(regex,userAgent){return regex.test(userAgent)};var IsMobileClass=function IsMobileClass(userAgent){var ua=userAgent||navigator.userAgent;var tmp=ua.split("[FBAN");if(typeof tmp[1]!=="undefined"){ua=tmp[0]}tmp=ua.split("Twitter");if(typeof tmp[1]!=="undefined"){ua=tmp[0]}this.apple={phone:match(apple_phone,ua),ipod:match(apple_ipod,ua),tablet:!match(apple_phone,ua)&&match(apple_tablet,ua),device:match(apple_phone,ua)||match(apple_ipod,ua)||match(apple_tablet,ua)};this.amazon={phone:match(amazon_phone,ua),tablet:!match(amazon_phone,ua)&&match(amazon_tablet,ua),device:match(amazon_phone,ua)||match(amazon_tablet,ua)};this.android={phone:match(amazon_phone,ua)||match(android_phone,ua),tablet:!match(amazon_phone,ua)&&!match(android_phone,ua)&&(match(amazon_tablet,ua)||match(android_tablet,ua)),device:match(amazon_phone,ua)||match(amazon_tablet,ua)||match(android_phone,ua)||match(android_tablet,ua)};this.windows={phone:match(windows_phone,ua),tablet:match(windows_tablet,ua),device:match(windows_phone,ua)||match(windows_tablet,ua)};this.other={blackberry:match(other_blackberry,ua),blackberry10:match(other_blackberry_10,ua),opera:match(other_opera,ua),firefox:match(other_firefox,ua),chrome:match(other_chrome,ua),device:match(other_blackberry,ua)||match(other_blackberry_10,ua)||match(other_opera,ua)||match(other_firefox,ua)||match(other_chrome,ua)};this.seven_inch=match(seven_inch,ua);this.any=this.apple.device||this.android.device||this.windows.device||this.other.device||this.seven_inch;this.phone=this.apple.phone||this.android.phone||this.windows.phone;this.tablet=this.apple.tablet||this.android.tablet||this.windows.tablet;if(typeof window==="undefined"){return this}};var instantiate=function instantiate(){var IM=new IsMobileClass;IM.Class=IsMobileClass;return IM};global.isMobile=instantiate()})(window);var COMP_CONF={appid:6,ws:isOa?"https://testwss.qidian.qq.com":"https://wpa.mango.qidian.qq.com",heartbeat:3*60,CGI_URL:function(){var domain=" https://".concat(isOa?"test":"","gateway.qidian.qq.com");return{SOCKET_CHAT:!!window.WebSocket&&window.WebSocket.prototype.send?"https://".concat(__domain.chat):"https://pollingchat.qidian.qq.com",COMP_SOURCE_URL:"https://".concat(__domain.source,".com/qidian/chatClient/release/comp/"),GET_MSG_DISPLAYED:"".concat(domain,"/v1/wpaVisitor/getMsgDisplayed"),autotInviteConf:"".concat(domain,"/v1/wpaVisitor/getInviteConf"),refuseInvite:"".concat(domain,"/v1/wpaVisitor/refuseInvite"),socketLoginConfig:"".concat(domain,"/v1/interface/inner/cloudim_324034"),POST_MSG_DISPLAYED:"".concat(domain,"/v1/wpaVisitor/displayMessageOnC"),bindWpaAndImAid:"".concat(domain,"/v1/wpaVisitor/aidBind")}}(),isLinkWPA:function(){var pageURL=window.location.href,isLinkWPA=getUrlQuery(pageURL,"linkType"),visitorId=getUrlQuery(pageURL,"visitorId"),isInIframe=window.parent==window?false:true;visitorId&&visitorId.length>0?isLinkWPA=1:"";if(isLinkWPA&&(""+isLinkWPA).length>0&&!isInIframe){return true}return false}(),SOCKET_OPTS:{OPTS:{path:"/session",reconnectionDelay:10000,reconnectionDelayMax:20000,reconnectionAttempts:2,timeout:20000,transports:["websocket"]},C2B_TIMEOUT:60000,SIGT_TIMEOUT:10000,REG_TIMEOUT:60000,SEQ_RANGE:{C2B_FOR_PHP:2147483647,C2B_FOR_PC:65535},CLIENT_PING_DELAY:20000,MAX_FAIL_TIMES:2},SOCKET_CMD:{REG:{EMIT:"register",RECEIVE:"register ack"},C2B:{EMIT:"message c2b",RECEIVE:"message c2b ack"},B2C:{RECEIVE:"message b2c",EMIT:"message b2c ack"},KF_CHANGE:{EMIT:"change kf",RECEIVE:"change kf ack"},ROUTE:{RECEIVE:"route change",EMIT:"route change ack"},OVER:{RECEIVE:"session over"},SESSION_MSG:{RECEIVE:"s_msg",EMIT:"s_msg_ack"},CLIENT_PING:{EMIT:"p"},INITVIDEO:{EMIT:"rtc_create_room",RECEIVE:"rtc_create_room_ack"},ROOMINFO:{EMIT:"rtc_get_room",RECEIVE:"rtc_get_room_ack"},VIDEOEVENT:{EMIT:"rtc_event_report",RECEIVE:"rtc_event_report_ack"},VIDEOSTATUS:{EMIT:"rtc_status_report",RECEIVE:"rtc_status_report_ack"},VIDEOPING:{EMIT:"rtc_health_check",RECEIVE:"rtc_health_check_ack"},VIDEOSMSG:{RECEIVE:"rtc_s_msg",EMIT:"rtc_s_msg_ack"},SESSION_END:{EMIT:"session_end",RECEIVE:"session_end_ack"},SCREEN_SHARE:{EMIT:"rtc_screen_share",RECEIVE:"rtc_screen_share_ack"}}};var DisplayManager=function(window){var renderArr=[];var displayArr=[];var index=0;var isClickedWpa=false;var timer=null;var aid,appid,d2,displayObjKey,ruleID,wpaId,kfuin;function getIsClickedWpa(data){isClickedWpa=data.isClickedWpa;log("isClickedWpa",isClickedWpa)}function appendItem(data,wpaData,dir){var body=document.body;var wrap=document.getElementById("wrap");if(!data[index]){setTimeout(function(){body.removeChild(wrap)},10*1000);return}if(isClickedWpa){clearTimeout(timer);return}var item=data[index];timer=setTimeout(function(){if(!isClickedWpa){renderArr.push(item);renderArr.splice(0,renderArr.length-3);render(data,dir);index++;appendItem(data,wpaData,dir)}else{setTimeout(function(){body.removeChild(wrap)},10*1000)}},item.interval*1000)}function postDisplayedCount(wpaData){if(!index)return;var params={ruleID:ruleID,msgNum:index};$.ajax({url:"".concat(COMP_CONF.CGI_URL.POST_MSG_DISPLAYED),data:params,type:"POST",timeout:3000,dataType:"json",headers:{"X-Appid":appid,"X-Aid":aid,"X-D2":d2,"X-Tenant-Id":kfuin},success:function success(res){if(res.code===0){log("\u4E0A\u62A5\u5DF2\u7ECF\u663E\u793A\u7684\u5916\u663E\u6D88\u606F",JSON.stringify(res))}},error:function error(err){log("err \u4E0A\u62A5\u5DF2\u7ECF\u663E\u793A\u7684\u5916\u663E\u6D88\u606F",err)}})}function postMsgSender(msgData){msgData&&postMsg.send(msgData,"ONLINE_STATUS")}var xssFilter=function xssFilter(html){if(!html)return html;html=html.replace(/<\s*\/?script\s*>/g,"").replace(/javascript:[^'"]*/g,"").replace(/onerror\s*=\s*['"]?[^'"]*['"]?/g,"");return html};function render(data,dir){var wrap=document.getElementById("wrap");var html=renderArr.map(function(value,index){return handleMsgType(value,index,dir)}).join("");wrap.innerHTML=xssFilter(html);log("===>>>>>wrap",wrap.offsetHeight);for(var i=0;i<data.length;++i){if(JSON.stringify(data[i])===JSON.stringify(renderArr[renderArr.length-1])){break}}displayArr=data.slice(0,index+1);var displayObj={ruleID:ruleID,ruleNum:displayArr.length};displayObjKey="displayObj"+wpaId+"_"+kfuin;sessionStorage.setItem(displayObjKey,JSON.stringify(displayObj));postMsgSender({act:"SM_DISPLAY",calHeight:true,offsetHeight:wrap.offsetHeight,wpaId:wpaId,kfuin:kfuin,ruleId:ruleID,displayNum:displayArr.length,msgDisplayId:ruleID})}function getSmallImgStyle(article){return"background-image: url(".concat(article.showUrl,")")}function handleMsgType(item,index,dir){var isTop=dir&&dir.top;var isLeft=dir&&dir.left;var borderRadius=calcBorderRadius(isTop,isLeft);var text=$(item.text).text();switch(Number(item.replyType)){case 3:return"<div title=\"".concat(text,"\" class=\"rich-text ").concat(isTop?"top-margin":"bottom-margin"," ").concat(borderRadius,"\">\n                           <div class=\"container\"> ").concat(item.text," </div>\n                        </div>");case 2:return"<div class=\"img-container ".concat(isTop?"top-margin":"bottom-margin"," ").concat(borderRadius,"\">\n                            <img src=\"").concat(item.img.imgUrl,"\" class=\"img\">\n                         </div>");case 1:return"<div class=\"img-txt-container ".concat(isTop?"top-margin":"bottom-margin"," ").concat(borderRadius,"\">\n                            <p class=\"summary\" title=\"").concat(item.imgTxt.articles[0].title,"\">").concat(item.imgTxt.articles[0].title,"</p>\n                            <div class=\"small-img\" style=\"").concat(getSmallImgStyle(item.imgTxt.articles[0]),"\"></div>\n                         </div>");}}function calcBorderRadius(isTop,isLeft){if(isTop){if(isLeft){return"bottom-left-zero"}else{return"bottom-right-zero"}}else{if(isLeft){return"top-left-zero"}else{return"top-right-zero"}}}function getMsgDisplayed(data,dir){kfuin=data.kfuin;ruleID=data.ruleId;aid=data.aid;appid=data.appid;d2=data.d2;wpaId=data.wpaId;var params={kfext:kfuin,ruleID:ruleID};$.ajax({url:"".concat(COMP_CONF.CGI_URL.GET_MSG_DISPLAYED,"?kfuin=").concat(kfuin),data:params,type:"POST",timeout:3000,dataType:"json",success:function success(res){if(res.code===0&&res.data){var msgDisplayed=res.data.msgDisplayed||"[]";log("\u63A5\u6536\u6765\u81EA\u540E\u53F0\u7684\u5916\u663E\u6D88\u606F",JSON.parse(msgDisplayed));appendItem(JSON.parse(msgDisplayed),data,dir)}},error:function error(err){log("err \u63A5\u6536\u6765\u81EA\u540E\u53F0\u7684\u5916\u663E\u6D88\u606F",err)}})}function showMessage(data,dir){var body=document.body,wrap=document.createElement("div");wrap.setAttribute("id","wrap");var isTop="".concat(dir&&!dir.top?"target-top":"normal");var isLeft="".concat(dir&&dir.left?"target-left":"target-right");wrap.classList.add(isLeft,isTop);getMsgDisplayed(data,dir);body.appendChild(wrap)}function postMsgListener(msgData){log("msgData.data",msgData,msgData.data,msgData.dir);showMessage(msgData.data,msgData.dir)}return{start:function start(){function receiveMessage(event){if(!event.data)return;switch(event.data.act){case"SM_DISPLAY":postMsgListener(event.data);break;case"IS_CLICKED_WPA":getIsClickedWpa(event.data);break;case"SM_MANUAL_INVITE":var wpaId=event.data.wpaId,kfuin=event.data.kfuin;sessionStorage.setItem("displayObj"+wpaId+"_"+kfuin,"");break;case"ON_IMSDK_READY":postDisplayedCount(event.data);break;}}window.addEventListener("message",receiveMessage,false)}}}(window);window.__DISPLAY_MANAGER=DisplayManager;DisplayManager.start()})();
//# sourceMappingURL=display.js.map
