(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-imsdk"],{4886:function(e,t,n){"use strict";n("ac1f"),n("5319"),"https://".concat(void 0,"/"),"https://wss-".concat(void 0,"/");var i={key:"DOMAIN_OA",api:"https://testgateway.qidian.qq.com",ws:"https://testwss.qidian.qq.com",consolecgi:"https://oaconsolecgi.qidian.qq.com",zhiwen:"https://oazhiwen.qidian.qq.com"},s="undefined"!=typeof location?"https://wss-".concat(location.host):"",o="undefined"!=typeof location?"https://".concat(location.host.replace(/^[^.]+/,"gateway")):"",a={key:"DOMAIN_OA_PRIVATE",api:o,ws:s,zhiwen:"",consolecgi:""},r={key:"DOMAIN_OL",api:"https://gateway.qidian.qq.com",ws:"https://c.mango.qidian.qq.com",consolecgi:"https://consolecgi.qidian.qq.com",zhiwen:"https://oazhiwen.qidian.qq.com"},_=a;_.key="DOMAIN_OL_PRIVATE";var c;c=r,t["a"]={SDK_DOMAIN_ENV:"",CUSTOMER_DOMAIN:null,setSDKDomainEnv:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"ol";this.SDK_DOMAIN_ENV=e},getSDKDomain:function(e){return this.CUSTOMER_DOMAIN?this.CUSTOMER_DOMAIN:Object({NODE_ENV:"production",BASE_URL:""}).IS_SDK?(e&&(this.SDK_DOMAIN_ENV=e),t="oa"===this.SDK_DOMAIN_ENV?i:r,t):c;var t},setSDKDomain:function(e){e.key||Object.assign(e,{key:"CUSTOMER"}),this.CUSTOMER_DOMAIN=e}}},5505:function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));n("d3b7"),n("ac1f"),n("25f0"),n("5319");function i(){return"xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0,n="x"==e?t:3&t|8;return n.toString(16)}))}},"9de0":function(e,t,n){"use strict";n.d(t,"a",(function(){return s["a"]})),n.d(t,"c",(function(){return i})),n.d(t,"b",(function(){return q}));var i={};n.r(i),n.d(i,"setDebug",(function(){return c})),n.d(i,"setLogReport",(function(){return m})),n.d(i,"_report",(function(){return d})),n.d(i,"_error",(function(){return g})),n.d(i,"_log",(function(){return f})),n.d(i,"getVisitorAndUuidAndToken",(function(){return P})),n.d(i,"updateLocalStorageVid",(function(){return U})),n.d(i,"initIM",(function(){return B})),n.d(i,"createVisitor",(function(){return K})),n.d(i,"loginQDIM",(function(){return J})),n.d(i,"newQDIM",(function(){return Q})),n.d(i,"generateUUID",(function(){return te})),n.d(i,"uploadImage",(function(){return ce})),n.d(i,"uploadFile",(function(){return ge})),n.d(i,"uploadVoice",(function(){return he})),n.d(i,"uploadLongText",(function(){return be})),n.d(i,"getDownloadUrl",(function(){return ve})),n.d(i,"downloadAndParseLongText",(function(){return ke})),n.d(i,"downloadAndParseSDKLongText",(function(){return Me})),n.d(i,"exitQueue",(function(){return Se})),n.d(i,"getMessageReadReceipt",(function(){return xe})),n.d(i,"reportMessageReadReceipt",(function(){return qe})),n.d(i,"getReqestHeaders",(function(){return Oe})),n.d(i,"setIMInstance",(function(){return Te})),n.d(i,"addToCustomerBase",(function(){return we}));var s=n("4886"),o=n("5530"),a=n("b85c"),r=(n("99af"),n("d81d"),n("14d9"),n("fb6a"),n("b0c0"),n("e9c4"),n("4ec9"),n("a9e3"),n("aff5"),n("b64b"),n("d3b7"),n("25f0"),n("3ca3"),n("159b"),n("ddb0"),n("14b7")),_=(n("13d5"),!0);function c(e){_=e}var u=function(){console.log("★report=========>",arguments[0])};function m(e){"function"===typeof e&&(u=e)}function d(e){u(e)}function g(e){if(_){for(var t,n,i=new Date,s="%s %s %s\n",o=arguments.length,a=new Array(o>1?o-1:0),r=1;r<o;r++)a[r-1]=arguments[r];if("string"===typeof e)s+=e,(t=console).error.apply(t,[s,i.toLocaleDateString(),i.toLocaleTimeString(),"[WebIM-SDK][error]:"].concat(a));else(n=console).error.apply(n,[s,i.toLocaleDateString(),i.toLocaleTimeString(),"[WebIM-SDK][error]:",e].concat(a))}}function f(e){if(_){for(var t,n,i=new Date,s="%s %s %s\n",o=arguments.length,a=new Array(o>1?o-1:0),r=1;r<o;r++)a[r-1]=arguments[r];if("string"===typeof e)s+=e,(t=console).log.apply(t,[s,i.toLocaleDateString(),i.toLocaleTimeString(),"[WebIM-SDK][log]:"].concat(a));else(n=console).log.apply(n,[s,i.toLocaleDateString(),i.toLocaleTimeString(),"[WebIM-SDK][log]:",e].concat(a))}}var p=n("5505");function l(e,t){return t.reduce((function(e,t){return e&&e[t]?e[t]:null}),e)}function h(){function e(e,i,s,o,a,r){return{msg_send_req:{msg_send_msg:{msg_package_head:{uint32_pkg_num:1,uint32_pkg_index:0,uint32_div_seq:1},msg_msg_head:t(e,i,s,0,a,r),msg_msg_body:n(o)}}}}function t(e,t,n,i,s){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},r=x(),_=n.crm_user_type;return _===w.config.channelType||(2===_?_=1:6===_&&(_=11)),{uint32_type:i||0,uint64_random:r,uint64_msg_time:Date.now(),uint32_from_term:e,uint32_client_ip:0,msg_type_info:{msg_c2c_info:{uint64_from_aid:t,uint64_to_aid:n.aid}},msg_app_info:{uint32_to_aid_type:1,uint32_from_aid_type:0},msg_third_app_info:{bytes_third_app_buf:{bytes_crm_buf:Object(o["a"])(Object(o["a"])({crm_user_type:_,str_cid:n.str_cid,str_visitId:n.str_cid,str_session_id:n.str_session_id,uint64_pubacc_id:n.uint64_pubacc_id,uint32_msg_id:n.uint32_msg_id||0,msg_attributes_info:{str_qidian_msg_unique_id:q(t,n.aid)},str_current_qidian_msg_unique_id:Object(p["a"])()},a),{},{msg_webim_extra_data:{bytes_wpaid:s.wpaId}})}}}}function n(e){return{rich_text:{elems:e}}}function i(e,t,n,i,o){return{msg_send_req:{msg_send_msg:{msg_package_head:{uint32_pkg_num:1,uint32_pkg_index:0,uint32_div_seq:1},msg_msg_head:s(e,t,n,i,o),msg_msg_body:null}}}}function s(e,t,n,i,s){var a=x(),r=n.crm_user_type;return r===s.channelType||(2===r?r=1:6===r&&(r=11)),{uint32_type:0,uint64_random:a,uint64_msg_time:Date.now(),uint32_from_term:e,uint32_client_ip:0,msg_type_info:{msg_c2c_info:{uint64_from_aid:t,uint64_to_aid:n.aid}},msg_app_info:{uint32_to_aid_type:1,uint32_from_aid_type:0},msg_third_app_info:{bytes_third_app_buf:{bytes_crm_buf:Object(o["a"])(Object(o["a"])({crm_user_type:r,str_cid:n.str_cid,str_visitId:n.str_cid,str_session_id:n.str_session_id,uint64_pubacc_id:n.uint64_pubacc_id,uint32_msg_id:n.uint32_msg_id||0,msg_attributes_info:{str_qidian_msg_unique_id:q(t,n.aid)},str_current_qidian_msg_unique_id:Object(p["a"])()},i),{},{msg_webim_extra_data:{bytes_wpaid:s.wpaId}})}}}}function r(e){var t=e.msg_ret_info;if(t&&0!==t.uint32_ret_code)return{code:t.uint32_ret_code,error:t.str_error_msg};var n=e.msg_send_rsp,i=n.msg_send_msg,s=i.msg_msg_head,r=s.uint64_random,_=s.uint64_msg_sync_seq,c=s.uint64_msg_roaming_seq,u=s.uint64_msg_time,m=s.msg_third_app_info||{bytes_third_app_buf:{bytes_crm_buf:""}},d=m.bytes_third_app_buf,g=d.bytes_crm_buf,p=s.msg_type_info,h=p.msg_c2c_info,y=h.uint64_from_aid,b=h.uint64_to_aid,v=i.msg_msg_body||{rich_text:"",revoke_message:""},k=v.revoke_message,M=v.rich_text,S=[];if(!M||g&&55===g.crm_flag){if(k)S.push({type:"revoke_msg",content:{seq:k.uint64_msg_roaming_seq,syncseq:k.uint64_msg_sync_seq,sidesyncseq:k.uint64_side_sync_seq,time:k.uint64_msg_time/1e3}});else if(g&&g.crm_flag){var x=g.crm_flag,q=g.template_message,O=g.msg_common_control_msg_info,T=g.msg_third_party_msg_info;14===x&&O?S.push({type:"qdxml_msg"}):55===x&&q?S.push({type:"robot"}):115===x&&O?S.push({type:"robot_nav"}):56===x&&O?S.push({type:"robot"}):T&&x&&S.push({type:"third_msg"})}}else{var w,E=M.elems||[],R=[],D=Object(a["a"])(E);try{for(D.s();!(w=D.n()).done;){var I=w.value;if(I)if(I.text)R.push({type:"text",content:I.text.str});else if(I.face)R.push({type:"face"});else if(I.media_resources)R.push({type:"media_resources"});else if(I.image)R.push({type:"image"});else if(I.long_msg)R.push({type:"long_msg"});else if(I.structured_info){var N=I.structured_info;1===N.uint32_format_flag?R.push({type:"qdxml_msg"}):2===N.uint32_format_flag?R.push({type:"image_text"}):f("structured_info uint32_format_flag error!",N.uint32_format_flag)}else I.file_info?R.push({type:"file_info"}):I.ptt_info?R.push({type:"ptt_info"}):R.push({type:"text",content:"[未知消息类型]"})}}catch(C){D.e(C)}finally{D.f()}1===R.length?S.push(Object(o["a"])({},R[0])):R.length>1&&S.push({type:"mix",content:R})}return{str_qidian_msg_unique_id:l(g,["msg_attributes_info","str_qidian_msg_unique_id"]),uuid:r,seq:c,syncseq:_,time:u/1e3,from:y,to:b,content:S}}function _(e){var t=e.push_new_message_notice,n=Number(t["uint64_msg_sync_seq"]);return n}function c(e,t,n){return{msg_sync_req:{uint64_sync_aid:e,uint64_sync_seq:t,uint32_sync_size:n}}}function u(e){var t,n=[],i=e.msg_sync_rsp||{rpt_msg_sync_msg:[]},s=i.rpt_msg_sync_msg||[],r=Object(a["a"])(s);try{for(r.s();!(t=r.n()).done;){var _=t.value;if(_){var c=_.msg_msg_head,u=c.uint64_msg_sync_seq,m=c.uint64_msg_roaming_seq,d=c.uint64_msg_time,g=c.msg_third_app_info||{bytes_third_app_buf:{bytes_crm_buf:""}},p=g.bytes_third_app_buf,l=p.bytes_crm_buf;l&&(3===l.crm_user_type?(l.str_cid=l.str_visitId,l.crm_user_type=w.config.channelType):1===l.crm_user_type?(l.str_cid="".concat(l.str_qidian_third_app_appid,"_").concat(l.str_wx_openid),l.crm_user_type=2):11===l.crm_user_type&&(l.str_cid="".concat(l.str_qidian_third_app_appid,"_").concat(l.str_wx_openid),l.crm_user_type=6));var h=c.msg_type_info,y=c.uint32_type,b=h.msg_c2c_info,v=b.uint64_from_aid,k=b.uint64_to_aid,M=_.msg_msg_body||{rich_text:"",revoke_message:""},S=M.revoke_message,x=M.rich_text,q={seq:m,syncseq:u,time:d/1e3,from:v,to:k,crm:l,msgHead:c,msgBody:M,isDynamicUpdate:2===y};if(l&&l["msg_common_audio_video"]){var E=T(l["msg_common_audio_video"]);n.push(Object(o["a"])(Object(o["a"])({},q),{},{type:"rtc_msg",content:E}))}else if(!x||l&&55===l.crm_flag)if(S)n.push(Object(o["a"])(Object(o["a"])({},q),{},{type:"revoke_msg",content:S.uint64_msg_roaming_seq,seq:S.uint64_msg_roaming_seq}));else if(l&&l.crm_flag){var R=l.crm_flag,D=l.template_message,I=l.msg_common_control_msg_info,N=l.msg_third_party_msg_info;if(14===R&&I){var C={path:I.str_control_msg_resid,brief:I.str_msg_brief,content:I.bytes_structure_content,resStore:I.uint32_res_store,compressed:I.uint32_structure_compress_type,cosBucket:I.uint32_cos_bucket};n.push(Object(o["a"])(Object(o["a"])({},q),{},{type:"qdxml_msg",content:C}))}else if(55===R&&D){var A=D.bytes_content,j=D.uint32_type,G=D.str_resid,L="";try{L=JSON.parse(A)}catch(V){}n.push(Object(o["a"])(Object(o["a"])({},q),{},{type:13===j?"robot_form":"robot",content:L,path:G}))}else if(115===R&&I)n.push(Object(o["a"])(Object(o["a"])({},q),{},{type:"robot_nav",content:{path:I.str_control_msg_resid,content:I.bytes_structure_content,resStore:I.uint32_res_store,compressed:I.uint32_structure_compress_type,cosBucket:I.uint32_cos_bucket}}));else if(56===R&&I){var P=I.bytes_structure_content,U=I.uint32_type;n.push(Object(o["a"])(Object(o["a"])({},q),{},{type:13===U?"robot_form":"robot",content:JSON.parse(P)}))}else if(11===R){var B=O(l);n.push(Object(o["a"])(Object(o["a"])({},q),{},{type:"gray_msg",content:B}))}else if(N&&R){O(l);n.push(Object(o["a"])(Object(o["a"])({},q),{},{type:"third_msg",content:{crmFlag:R,path:N.string_res_id,brief:N.string_msg_brief,content:N.string_msg_content,resStore:N.uint32_res_store}}))}}else n.push(Object(o["a"])(Object(o["a"])({},q),{},{content:null}));else{var z,F=x.elems||[],K=[],Y=Object(a["a"])(F);try{for(Y.s();!(z=Y.n()).done;){var J=z.value;if(J)if(J.text)K.push({type:"text",content:J.text.str});else if(J.face)K.push({type:"face",index:J.face.uint32_index,content:J.face.bytes_default_text||"[自定义表情]"});else if(J.media_resources)K.push({type:"media_resources",meida_type:J.media_resources.int32_meida_type,media_url:J.media_resources.bytes_media_url,content:J.media_resources.bytes_media_url});else if(J.image)K.push({type:"image",uuid:J.image.bytes_uuid,content:J.image.bytes_image_path,md5:J.image.bytes_image_md5,name:J.image.bytes_image_name,size:J.image.uint32_image_size,width:J.image.uint32_image_width,height:J.image.uint32_image_height,format:J.image.uint32_image_format,resStore:J.image.uint32_res_store,cosBucket:J.image.uint32_cos_bucket});else if(J.long_msg)K.push({type:"long_msg",content:J.long_msg.bytes_longmsg_path,uuid:J.long_msg.bytes_uuid,resStore:J.long_msg.uint32_res_store,compressed:J.long_msg.uint32_compress_type,cosBucket:J.long_msg.uint32_cos_bucket});else if(J.structured_info){var Q=J.structured_info;1===Q.uint32_format_flag?K.push({type:"qdxml_msg",content:{uuid:Q.bytes_uuid,path:Q.bytes_structure_path,brief:Q.str_msg_brief,content:Q.bytes_structure_content,resStore:Q.uint32_res_store,compressed:Q.uint32_structure_compress_type,cosBucket:Q.uint32_cos_bucket}}):2===Q.uint32_format_flag?K.push({type:"image_text",uuid:Q.bytes_uuid,path:Q.bytes_structure_path,content:Q.bytes_structure_content,format:Q.uint32_format_flag,resStore:Q.uint32_res_store,compressed:Q.uint32_structure_compress_type,cosBucket:Q.uint32_cos_bucket}):f("structured_info uint32_format_flag error!",Q.uint32_format_flag)}else J.file_info?K.push({type:"file_info",uuid:J.file_info.bytes_uuid,content:J.file_info.bytes_file_path,md5:J.file_info.bytes_file_md5,name:J.file_info.bytes_file_name,size:J.file_info.uint32_file_size,format:J.file_info.bytes_file_format,cosBucket:J.file_info.uint32_cos_bucket}):J.ptt_info?K.push({type:"ptt_info",uuid:J.ptt_info.bytes_uuid,content:J.ptt_info.bytes_ptt_path,md5:J.ptt_info.bytes_ptt_md5,length:J.ptt_info.uint32_ptt_length,size:J.ptt_info.uint32_ptt_size,format:J.ptt_info.uint32_format,cosBucket:J.ptt_info.uint32_cos_bucket}):K.push({type:"text",content:"[未知消息类型]"})}}catch(X){Y.e(X)}finally{Y.f()}1===K.length?n.push(Object(o["a"])(Object(o["a"])({},q),K[0])):K.length>1&&n.push(Object(o["a"])(Object(o["a"])({},q),{},{type:"mix",content:K}))}}}}catch(X){r.e(X)}finally{r.f()}return n}function m(e,t,n,i){return{msg_roaming_req:{uint32_roaming_type:1,uint32_type:0,msg_type_info:{msg_c2c_info:{uint64_from_aid:e,uint64_to_aid:t}},msg_roaming_seq_info:{uint64_roaming_seq:n,uint32_direction:1,uint32_size:i,uint64_begin_time:0,uint64_end_time:0}}}}function d(e,t,n,i,s){return{msg_roaming_req:{uint32_roaming_type:1,uint32_type:0,msg_type_info:{msg_c2c_info:{uint64_from_aid:0,uint64_to_aid:n}},msg_roaming_seq_info:{uint64_roaming_seq:i,uint32_direction:1,uint32_size:s,uint64_begin_time:0,uint64_end_time:0},str_user_openid:t,uint32_appid:e}}}function g(e){var t,n=[],i=e.msg_roaming_rsp||e.webim_roaming_adapted_rsp||{rpt_msg_roaming_msg:[]},s=i.rpt_msg_roaming_msg||i.rpt_msg_sync_msg||[],r=Object(a["a"])(s);try{for(r.s();!(t=r.n()).done;){var _=t.value;if(_){var c=_.msg_msg_head,u=c.uint32_status,m=c.uint64_msg_roaming_seq,d=c.uint64_msg_time,g=c.msg_third_app_info||{bytes_third_app_buf:{bytes_crm_buf:""}},p=g.bytes_third_app_buf,l=p.bytes_crm_buf,h=c.msg_type_info,y=(c.uint32_type,h.msg_c2c_info),b=y.uint64_from_aid,v=y.uint64_to_aid,k=_.msg_msg_body||{rich_text:""},M=k.rich_text,S={seq:m,time:d/1e3,from:b,to:v,crm:l,msgHead:c,msgBody:k,revoke:u};if(l&&l["msg_common_audio_video"]){var x=T(l["msg_common_audio_video"]);n.push(Object(o["a"])(Object(o["a"])({},S),{},{type:"rtc_msg",content:x}))}else if(!M||l&&55===l.crm_flag)if(l&&l.crm_flag){var q=l.crm_flag,w=l.template_message,E=l.msg_common_control_msg_info,R=l.msg_third_party_msg_info;if(14===q&&E){var D={path:E.str_control_msg_resid,brief:E.str_msg_brief,content:E.bytes_structure_content,resStore:E.uint32_res_store,compressed:E.uint32_structure_compress_type,cosBucket:E.uint32_cos_bucket};n.push(Object(o["a"])(Object(o["a"])({},S),{},{type:"qdxml_msg",content:D}))}else if(55===q&&w){var I=w.bytes_content,N=w.uint32_type,C=w.str_resid,A="";try{A=JSON.parse(I)}catch(Y){}13!==N&&n.push(Object(o["a"])(Object(o["a"])({},S),{},{type:"robot",content:A,path:C}))}else if(115===q&&E)n.push(Object(o["a"])(Object(o["a"])({},S),{},{type:"robot_nav",content:{path:E.str_control_msg_resid,content:E.bytes_structure_content,resStore:E.uint32_res_store,compressed:E.uint32_structure_compress_type,cosBucket:E.uint32_cos_bucket}}));else if(56===q&&E){var j=E.bytes_structure_content,G=E.uint32_type;13!==G&&n.push(Object(o["a"])(Object(o["a"])({},S),{},{type:"robot",content:JSON.parse(j)}))}else if(R&&q)n.push(Object(o["a"])(Object(o["a"])({},S),{},{type:"third_msg",content:{crmFlag:q,path:R.string_res_id,brief:R.string_msg_brief,content:R.string_msg_content,resStore:R.uint32_res_store}}));else if(11===q){var L=O(l);n.push(Object(o["a"])(Object(o["a"])({},S),{},{type:"gray_msg",content:L}))}}else n.push(Object(o["a"])(Object(o["a"])({},S),{},{content:null}));else{var P,U=M.elems||[],B=[],z=Object(a["a"])(U);try{for(z.s();!(P=z.n()).done;){var F=P.value;if(F)if(F.text)B.push({type:"text",content:F.text.str});else if(F.face)B.push({type:"face",index:F.face.uint32_index,content:F.face.bytes_default_text||"[自定义表情]"});else if(F.media_resources)B.push({type:"media_resources",meida_type:F.media_resources.int32_meida_type,media_url:F.media_resources.bytes_media_url,content:F.media_resources.bytes_media_url});else if(F.image)B.push({type:"image",uuid:F.image.bytes_uuid,content:F.image.bytes_image_path,md5:F.image.bytes_image_md5,name:F.image.bytes_image_name,size:F.image.uint32_image_size,width:F.image.uint32_image_width,height:F.image.uint32_image_height,format:F.image.uint32_image_format,resStore:F.image.uint32_res_store,cosBucket:F.image.uint32_cos_bucket});else if(F.long_msg)B.push({type:"long_msg",content:F.long_msg.bytes_longmsg_path,uuid:F.long_msg.bytes_uuid,resStore:F.long_msg.uint32_res_store,compressed:F.long_msg.uint32_compress_type,cosBucket:F.long_msg.uint32_cos_bucket});else if(F.structured_info){var K=F.structured_info;1===K.uint32_format_flag?B.push({type:"qdxml_msg",content:{uuid:K.bytes_uuid,path:K.bytes_structure_path,brief:K.str_msg_brief,content:K.bytes_structure_content,resStore:K.uint32_res_store,compressed:K.uint32_structure_compress_type,cosBucket:K.uint32_cos_bucket}}):2===K.uint32_format_flag?B.push({type:"image_text",uuid:K.bytes_uuid,path:K.bytes_structure_path,content:K.bytes_structure_content,format:K.uint32_format_flag}):f("structured_info uint32_format_flag error!",K.uint32_format_flag)}else F.file_info?B.push({type:"file_info",uuid:F.file_info.bytes_uuid,content:F.file_info.bytes_file_path||F.file_info.bytes_uuid,md5:F.file_info.bytes_file_md5,name:F.file_info.bytes_file_name,size:F.file_info.uint32_file_size,format:F.file_info.bytes_file_format,cosBucket:F.file_info.uint32_cos_bucket}):F.ptt_info?B.push({type:"ptt_info",uuid:F.ptt_info.bytes_uuid,content:F.ptt_info.bytes_ptt_path,md5:F.ptt_info.bytes_ptt_md5,length:F.ptt_info.uint32_ptt_length,size:F.ptt_info.uint32_ptt_size,format:F.ptt_info.uint32_format,cosBucket:F.ptt_info.uint32_cos_bucket}):B.push({type:"text",content:"[未知消息类型]"})}}catch(J){z.e(J)}finally{z.f()}1===B.length?n.push(Object(o["a"])(Object(o["a"])({},S),B[0])):B.length>1&&n.push(Object(o["a"])(Object(o["a"])({},S),{},{type:"mix",content:B}))}}}}catch(J){r.e(J)}finally{r.f()}return n}function h(e,t,n){return{get_msg_contact_req:{str_data_context:e,uint32_offset:t,uint32_limit:n,uint32_type:1}}}function y(e){var t,n=[],i=e["get_msg_contact_rsp"]||{str_data_context:"",uint64_max_sync_seq:0,msg_recent_contact_info:[]},s=i["str_data_context"],o=i["uint64_max_sync_seq"],r=i["msg_recent_contact_info"]||[],_=Object(a["a"])(r);try{for(_.s();!(t=_.n()).done;){var c=t.value;if(c){var u=c["contact_id_info"],m=u["uint32_type"],d=u["uint64_contact_id"],g=c["extend_info"]||{},f=g["str_session_id"]||"",p=g["str_user_id"]||"",l=g["uint64_pubacc_id"]||0,h=g["user_type"]||0;3===h?h=w.config.channelType:1===h?h=2:11===h&&(h=6);var y=c["str_msg_summary"],b=c["uint32_unread_cnt"],v=c["uint64_msg_unique_seq"],k=c["uint64_msg_sync_seq"],M=c["uint32_block_status"],S=c["uint32_top_status"],x=c["uint64_top_time"],q=c["uint64_msg_time"];n.push({id:d,type:m,summary:y,seq:v,syncseq:k,unread:b,msgtime:q/1e3,block:M,top:S,toptime:x/1e3,extend:{str_session_id:f,str_user_id:p,user_type:h,uint64_pubacc_id:l}})}}}catch(O){_.e(O)}finally{_.f()}return{str_data_context:s,uint64_max_sync_seq:o,contact:n}}function b(e,t,n){return{msg_read_report_req:{msg_read_report_info:[{uint64_msg_roaming_seq:n,contact_id_info:{uint32_type:t,uint64_contact_id:e}}]}}}function v(e){var t,n=[],i=e.msg_read_report_rsp||{failed_msg_read_report_info:[]},s=i.failed_msg_read_report_info||[],o=Object(a["a"])(s);try{for(o.s();!(t=o.n()).done;){var r=t.value;if(r&&r["contact_id_info"]){var _=r.uint64_msg_roaming_seq,c=r.contact_id_info,u=c.uint32_type,m=c.contact_id_info;n.push({seq:_,id:m,type:u})}}}catch(d){o.e(d)}finally{o.f()}return n}function k(e,t,n,i,s,o){var a={uint32_http_method:e};return 3!==e&&(a.bytes_header_content_type="application/octet-stream"),{generate_presigned_url_req:{uint32_business_type:10,http_message:a,obj_message:{bytes_obj_resid:t,uint64_obj_size:n,uint32_obj_type:i,bytes_obj_name:encodeURIComponent(s)},uint32_cos_bucket:"undefined"!==typeof o?o:0}}}function M(e){var t=e.generate_presigned_url_rsp,n=t.http_message,i=n.uint32_http_method,s=t.bytes_uuid,o=t.bytes_host,a=t.bytes_presigned_url,r=t.post_cos_sign_info,_=void 0===r?null:r;return{method:i,host:o,url:a,uuid:s,postSignInfo:_}}function S(e,n,i,s,o){return{msg_send_req:{msg_send_msg:{msg_package_head:{uint32_pkg_num:1,uint32_pkg_index:0,uint32_div_seq:1},msg_msg_head:t(e,n,i,1,o),msg_msg_body:{revoke_message:{uint64_msg_roaming_seq:s.uint64_msg_roaming_seq,uint64_msg_time:s.uint64_msg_time,uint64_msg_sync_seq:s.uint64_msg_sync_seq,uint64_side_sync_seq:s.uint64_side_sync_seq}}}}}}function x(){if("undefined"!==typeof window){var e=window.performance||window.msPerformance||window.webkitPerformance;if(e&&e.timeOrigin){var t=e.timeOrigin+e.now();return 1e4*t+Math.floor(1e4*Math.random())}if(e&&e.timing){var n=e.timing.navigationStart+e.now();return 1e4*n+Math.floor(1e4*Math.random())}}return 1e4*Date.now()+Math.floor(1e4*Math.random())}function q(e,t){return Object(p["a"])()}function O(e){var t="[未知消息类型]",n="",i=e.msg_gray_msg,s=e.msg_webim_extra_data,o=e.crm_alloc_kfext;console.log(e,"unpackMsgGrayMsg");var r=e.msg_linktext_with_open_chat_msg_notify;if(i){var _=i.msg_track_info||"";if(_&&(n={c_id:_.str_c_id,session_id:_.str_session_id,session_type:_.uint32_session_type,begin_time:_.uint64_begin_time,end_time:_.uint64_end_time}),i.str_text)t=i.str_text;else{var c,u=i.rpt_msg_str_text||[],m=Object(a["a"])(u);try{for(m.s();!(c=m.n()).done;){var d=c.value;d.str_i18n_key;t=d.string_text}}catch(g){m.e(g)}finally{m.f()}}}else o?t=o.crm_msg:r&&(t=r.string_tips);return{gray:t,track:n,msg_webim_extra_data:s}}function T(e){e["str_i18n_key"],e["uint32_roomid"],e["uint64_msgtime"];var t=e["str_text_msg"]||"[未知消息内容]",n=e["uint32_call_type"],i=e["uint32_video_state"],s=e["uint32_video_status_type"];return{str_text_msg:t,uint32_call_type:n,uint32_video_state:i,uint32_video_status_type:s}}var w={config:{kfuin:0,from:0,term:0,wpaId:0,channelType:50},initial:function(e){this.config.kfuin=e.kfuin,this.config.from=e.from,this.config.term=e.term,this.config.wpaId=e.wpaId,this.config.channelType=e.channelType,this.config.cosBucket=e.cosBucket},createTextMessage:function(t,n,i){var s,o=[],r=Object(a["a"])(n);try{for(r.s();!(s=r.n()).done;){var _=s.value;"text"===_.type?o.push({text:{str:_.content||""}}):"media_resources"===_.type?o.push({media_resources:{int32_meida_type:_.mediaType||0,bytes_media_url:_.mediaUrl||""}}):"face"===_.type&&o.push({face:{uint32_index:_.index,bytes_default_text:_.content||""}})}}catch(u){r.e(u)}finally{r.f()}var c=e(this.config.term,this.config.from,t,o,this.config,i);return c},createImageMessage:function(t,n){var i=[{image:{bytes_uuid:n.uuid||"",bytes_image_path:n.path||"",bytes_image_md5:n.md5||"",bytes_image_name:n.name||"",uint32_image_size:n.size||0,uint32_image_width:n.width||0,uint32_image_height:n.height||0,uint32_image_format:n.format||0,uint32_cos_bucket:this.config.cosBucket||0}}],s=e(this.config.term,this.config.from,t,i,this.config);return s},createImageTextMessage:function(t,n){var i=[{structured_info:{bytes_uuid:n.uuid||"",bytes_structure_path:n.path||"",uint32_format_flag:2,bytes_structure_content:n.content||"",uint32_cos_bucket:this.config.cosBucket||0}}];t.uint32_msg_id=n.id;var s=e(this.config.term,this.config.from,t,i,this.config);return s},createQDXMLMessage:function(e,t,n){var s=t.msg_common_control_msg_info||{str_control_msg_resid:"",uint64_kfuin:this.config.kfuin,str_msg_brief:""},a=t.msg_third_party_msg_info||{string_msg_brief:"",string_res_id:""},r=i(this.config.term,this.config.from,e,Object(o["a"])({crm_flag:14,msg_common_control_msg_info:{str_control_msg_resid:s.str_control_msg_resid,uint64_kfuin:this.config.kfuin,str_msg_brief:s.str_msg_brief,bytes_structure_content:"",uint32_res_store:1,uint32_cos_bucket:this.config.cosBucket||0},msg_third_party_msg_info:{string_msg_brief:a.string_msg_brief,string_res_id:a.string_res_id,string_msg_content:"",uint32_res_store:1,uint32_cos_bucket:this.config.cosBucket||0}},n),this.config);return r},createFileMessage:function(t,n){var i=[{file_info:{bytes_uuid:n.uuid||"",bytes_file_path:n.path||"",bytes_file_md5:n.md5||"",bytes_file_name:n.name||"",uint32_file_size:n.size||0,bytes_file_format:n.format||"",uint32_cos_bucket:this.config.cosBucket||0}}],s=e(this.config.term,this.config.from,t,i,this.config);return s},createPttMessage:function(t,n){var i=[{ptt_info:{bytes_uuid:n.uuid||"",bytes_ptt_path:n.path||"",bytes_ptt_md5:n.md5||"",uint32_ptt_length:n.length||0,uint32_ptt_size:n.size||0,uint32_format:n.format||0,uint32_cos_bucket:this.config.cosBucket||0}}],s=e(this.config.term,this.config.from,t,i,this.config);return s},createLongTextMessage:function(t,n,i){var s=[{long_msg:{bytes_uuid:n.uuid||"",bytes_longmsg_path:n.path||"",bytes_longmsg_md5:n.md5||"",uint32_longmsg_length:n.length||0,uint32_cos_bucket:this.config.cosBucket||0,uint32_compress_type:n.compressType||0,bytes_longmsg_brief:n.brief||""}}],o=e(this.config.term,this.config.from,t,s,this.config,i);return o},unpackMsgSendRsp:function(e){return r(e)},createSyncMessage:function(e,t){return c(this.config.from,e,t)},unpackMsgSyncRsp:function(e){return u(e)},unpackNewMsgNotice:function(e){return _(e)},createMsgRoamingReq:function(e,t,n){return m(this.config.from,e,t,n)},createSDKMsgRoamingReq:function(e,t,n,i,s){return d(e,t,n,i,s)},unpackMsgRoamingRsp:function(e){return g(e)},createMsgContactReq:function(e,t,n){return h(e,t,n)},unpackMsgContactRsp:function(e){return y(e)},createMsgReadReq:function(e,t,n){return b(e,t,n)},unpackMsgReadRsp:function(e){return v(e)},createMsgUploadReq:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=arguments.length>4?arguments[4]:void 0,o=this.config.cosBucket;1===s&&(o=0),2===s&&(o=1);var a=String(x());return k(i?4:2,a,t,e,n,o)},createMsgDownloadReq:function(e,t,n,i,s,o){var a;return"undefined"!==typeof o&&null!==o?a=o:"undefined"!==typeof s&&null!==s&&(1===s&&(a=0),2===s&&(a=1)),"undefined"===typeof a&&(a=this.config.cosBucket),k(3,e,n,t,i,a)},unpackMsgUploadOrDownloadRsp:function(e){return M(e)},createRevokeMessage:function(e,t){return S(this.config.term,this.config.from,e,t,this.config)},createMsgClientIncomingReq:function(e){return{msg_handle_incoming_msq_req:{uint32_channel_type:e.channel_type||this.config.channelType,uint64_kfuin:this.config.kfuin,bytes_openid:String(this.config.from),bytes_wpaid:this.config.wpaId,bytes_extra_content:e.extraContent||e.extra_content||"",str_useragent:e.userAgent||"undefined"!==typeof navigator&&navigator.userAgent||"",bytes_user_info:e.userInfo||"",custom_params:e.customParams||""}}},createMsgQdmenuReq:function(e){return"string"===typeof e.args&&-1===e.args.indexOf("wpaId")&&(e.args+="".concat(e.args.indexOf("?")>-1?"&":"?","wpaId=").concat(this.config.wpaId)),{msg_inner_im_menu_event_req:{bytes_user_data:e.args,uint64_kfuin:this.config.kfuin,uint32_ctype:this.config.channelType,str_cid:String(this.config.from),bytes_content:e.text}}},createMsgCloseSessiongReq:function(e){return{msg_customer_close_session_req:{uint32_session_type:this.config.channelType,uint64_kfuin:Number(this.config.kfuin),str_cid:String(this.config.from)}}},createMsgGetCustomerDetailReq:function(e){return{msg_inner_get_customer_detail_data_req:{uint64_kfuin:this.config.kfuin,uint64_kfext:Number(e.extuin),msg_customer_account:{uint32_contact_account_type:2,bytes_account_value1:String(e.extuin)}}}},createUpdateOnlineReq:function(e){return{set_message_tag_req:{uint64_from_uin:e.from,uint64_to_uin:e.to,uint64_msg_roaming_id:e.roamingId,rpt_msg_tag:e.tags}}},createSetAidInfoReq:function(e){return{set_aid_info_req:{uint64_aid:Number(this.config.from),msg_aid_info_data:Object(o["a"])({},e)}}},createC2bSessionStartReq:function(e){return{msg_c2b_session_start_req:{uint64_corpuin:Number(this.config.kfuin),str_c_id:String(e.cid),uint32_c_type:Number(this.config.channelType),msg_create_session_in:{uint32_strategy_type:Number(e.assignType),uint64_strategy_param:Number(e.assignId)}}}},createActiveFeedbackReq:function(e){return{msg_push_satisfaction_survey_all_channel_req:{uint32_channel:Number(this.config.channelType),uint32_send_type:5,str_cid:String(e.cid)}}},createCompressedLongTextMsgDownloadReq:function(e,t){var n,i=e.resStore,s=e.cosBucket;"undefined"!==typeof s&&null!==s?n=s:"undefined"!==typeof i&&null!==i&&(1===i&&(n=0),2===i&&(n=1)),"undefined"===typeof n&&(n=this.config.cosBucket);var o={uint32_cloudim_appid:e.appid,uint64_kfuin:e.kfuin,cos_bucket:n};return"xml"===t?Object.assign(o,{uint32_msg_type:1,struct_msg_info:{str_path:e.path,uint32_compress_type:e.compressed}}):Object.assign(o,{uint32_msg_type:4,long_msg_info:{str_path:e.path}}),o},createExitQueueMessage:function(e){var t={uint32_type:e.type||2,str_cid:String(e.cid)},n={uint64_kfuin:this.config.kfuin,uint32_delete_reason:8,rpt_msg_wait_pool_customer_info:[t]};return n},createOldMsgRoamingReq:function(e,t,n){return{webim_roaming_adapted_req:{uint64_begin_timestamp:0,uint64_end_timestamp:t,uint32_size:n,uint32_direction:1}}},createMsgSessionGetReq:function(e){return{msg_session_get_req:{msg_head:{uint64_session_type:this.config.channelType,uint64_kfuin:this.config.kfuin,str_visitid:String(e.cid)},bool_only_assgin:!1}}},createReportMsgReadReportReq:function(e){return{report_msg_read_report_req:{int32_ctype:this.config.channelType,string_client_term_type:e.clientTermType,string_cid:e.cid,string_seq_id:String(e.seq),uint64_time:e.time}}},createGetMsgReadInfoReq:function(e){return{get_msg_read_report_req:{uint64_kfuin:Number(this.config.kfuin),int32_ctype:this.config.channelType,string_cid:e.cid}}}};return w}var y,b,v,k=h;function M(e){}function S(){var e,t,n=Object(r["a"])(),i=new Map,s=-1,_=0,c=[],u=!1,m=0,d=function(){console.log("★report=========>",arguments[0])},p={},l=new Map,h=18e4,S=0,x=5,q=1,O=!1,T=0,w=k(),E={_sid:Math.random().toString(36).substring(2),_buildTime:"4/24/2024, 7:13:06 PM",sessionStarted:!1,config:{roamingMsgSize:10,syncMsgSize:5,contactMsgSize:50,channelType:50,cosBucket:0},create:function(n){if(!u){if(f("初始化配置值:",n),!n.socketio)return g("Instant没有正确初始化",n.socketio),void d({module:"c-imsdk",method:"[create][error]",from:s,message:"socketio-miss"});if(n.Instant)e=n.Instant;else{if("undefined"===typeof window||!window.Instant)return g("Instant对象没有传入也为在window上找到",n.Instant),void d({module:"c-imsdk",method:"[create][error]",from:-1,message:"Instant-miss"});e=window.Instant}t=n.socketio}},login:function(o){var r=this,c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},u=Number(o.uin),l=Number(o.corpUin);if(isNaN(u))return g("登录用户标识(uin)不是数值类型",o.uin),void d({module:"c-imsdk",method:"[login][error]",from:u,message:o});s=u,l,w.initial({kfuin:l,from:u,term:o.term||5,wpaId:String(c.wpaId)||"",channelType:this.config.channelType,cosBucket:this.config.cosBucket}),t.ready().then((function(e){f("Instant Ready",e),d({module:"c-imsdk",method:"onReady",from:s,message:"Event"}),r.sendContactMessage()})),t.on(e.NOTIFY_MESSAGE_TYPE.PUSH_NEW_MESSAGE_NOTICE,this.onMessageNotify),t.on(e.NOTIFY_MESSAGE_TYPE.NOTIFY_KICK_USER,(function(){d({module:"c-imsdk",method:"onKickout",from:s,message:"Event"}),clearTimeout(m),n.emit(y.RECEPTION_CHANGE,{}),n.emit(y.KICKED_OUT)})),t.on(e.NOTIFY_MESSAGE_TYPE.RECONNECT,(function(){r.sendSyncMessage(_+1,[]),r.getReceptionStatus()})),t.on(e.NOTIFY_MESSAGE_TYPE.NOTIFY_NEW_SC_MESSAGE,(function(e){d({module:"c-imsdk",method:"onScMessage",from:s,message:{result:e}});var t,o=e,_=Object(a["a"])(o);try{var c=function(){var e=t.value,o=e["uint32_sub_msgtype"],a=e["uint32_sub_command"],_=JSON.parse(e["bytes_sc_data"]);if(528===o&&146===a){var c=_["msg_crm_common_head"]||{};if(122===c["uint32_crm_sub_cmd"]){var u=_["msg_s2c_push_black_status_notify"]||{},m=u["str_tips"]||"",g=u["bytes_source_value"],l=u["uint32_source_type"];m&&g&&l&&(3===l?l=r.config.channelType:1===l?l=2:11===l&&(l=6),i.forEach((function(e,t){if(e.extend.str_user_id===g&&e.extend.user_type===l){var i={};i[t]=[{id:t,content:m}],n.emit(y.NOTIFY_PUSH,i)}})))}else if(124===_["uint32_sub_cmd"]){var h=_.msg_s2c_push_rtc_command_notify;n.emit(y.NOTIFY_RTC,h)}else if(143===_["uint32_sub_cmd"]){var b=_.msg_read_info_change_event;if(b){var v={seq:Number(b.string_seq_id),time:b.uint64_time};n.emit(y.READ_RECEIPT,v)}}}else if(528===o&&229===a){var k=_["msg_crm_common_head"]||{},M=k["uint32_crm_sub_cmd"],S=_["msg_s2c_manual_session_push"]||{},x=_["msg_s2c_robot_session_push"]||{},q=_["msg_s2c_queue_info_push"]||{},O=_["msg_s2c_input_status_sync_push"]||{};if(f("[sc event]",_),[28,29,31].indexOf(M)>-1){var T={};28===M&&1===S["uint32_event_type"]?T.extuin=S["uint64_kfext"]:29===M&&1===x["uint32_event_type"]?1===x["uint32_robot_type"]?(T.isLargeModelRobot=!0,T.largeModelRobotId=Number(x["string_robot_id"])):(T.isRobot=!0,T.robotId=Number(x["string_robot_id"])):31===M&&1===q["uint32_event_type"]&&(T.inWaitPool=!0),r.updateReception(T),d({module:"c-imsdk",method:"onRecptionChange",from:s,message:{reception:T}})}else if([32].indexOf(M)>-1){var w=O["uint32_event_type"],E=O["uint64_from_uin"];p&&E===p.extuin&&n.emit(y.TYPING,{typing:1===w})}else if(33===M){var R=_["msg_s2c_qq_invatation_push"]||{};n.emit(y.INVITE_QQ,{data:R})}else if(34===M){var D=_["msg_s2c_qq_business_card_push"]||{};n.emit(y.ADD_QQ_CARD,{data:D})}}};for(_.s();!(t=_.n()).done;)c()}catch(u){_.e(u)}finally{_.f()}})),t.on(e.NOTIFY_MESSAGE_TYPE.ERROR,(function(e){d({module:"c-imsdk",method:"onError",from:s,message:e}),n.emit(y.ERROR,e)})),M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:4,str_log:"[c-imsdk_login]"}]}}),d({module:"c-imsdk",method:"[login][done]",from:s,message:""})},logout:function(){clearTimeout(m),t&&t.close(),u=!1,M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:4,str_log:"[c-imsdk_logout]"}]}}),d({module:"c-imsdk",method:"logout",from:s,message:""})},reConnect:function(){var e=this;t&&t.createConnect(),t.ready().then((function(t){f("Instant Ready 2",t),d({module:"c-imsdk",method:"reConnect-onReady",from:s,message:"Event"}),e.sendContactMessage()})),M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:4,str_log:"[c-imsdk_reConnect]"}]}}),d({module:"c-imsdk",method:"reConnect",from:s,message:""})},createTextMessage:function(e){var n=Number(e.to);if(!isNaN(n)){M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:4,str_log:"[c-imsdk_createTextMessage][".concat(n,"]")}]}}),d({module:"c-imsdk",method:"createTextMessage",from:s,to:n,message:{payload:e.payload}});var o=e.payload||{text:""},a=e.payload.user_id,r=e.payload.user_type,_=e.payload.pubacc_id,c="",u=i.get(n);return u&&u.extend&&(a=u.extend.str_user_id||a,r=u.extend.user_type||r,c=u.extend.str_session_id||c,_=u.extend.uint64_pubacc_id||_),w.createTextMessage({aid:n,crm_user_type:r,str_cid:a,str_session_id:c,uint64_pubacc_id:_},o.text,o.crmData)}g("消息接收方(to)不是数值类型",e.to)},createImageMessage:function(e){var n=Number(e.to);if(!isNaN(n)){M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:4,str_log:"[c-imsdk_createImageMessage][".concat(n,"]")}]}}),d({module:"c-imsdk",method:"createImageMessage",from:s,to:n,message:{payload:e.payload}});var o=e.payload||{image:{}},a=e.payload.user_id,r=e.payload.user_type,_=e.payload.pubacc_id,c="",u=i.get(n);return u&&u.extend&&(a=u.extend.str_user_id||a,r=u.extend.user_type||r,c=u.extend.str_session_id||c,_=u.extend.uint64_pubacc_id||_),w.createImageMessage({aid:n,crm_user_type:r,str_cid:a,str_session_id:c,uint64_pubacc_id:_},o.image)}g("消息接收方(to)不是数值类型",e.to)},createImageUploadMessage:function(e){return M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:4,str_log:"[c-imsdk_createImageUploadMessage]"}]}}),d({module:"c-imsdk",method:"createImageUploadMessage",from:s,message:""}),w.createMsgUploadReq(v.OBJ_IMAGE,e.size,e.name,"string"===typeof e.method&&"post"===e.method.toLowerCase(),e.resStore)},createImageDownloadMessage:function(e){return M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:4,str_log:"[c-imsdk_createImageDownloadMessage][".concat(e.path,"]")}]}}),d({module:"c-imsdk",method:"createImageDownloadMessage",from:s,message:{path:e.path}}),w.createMsgDownloadReq(e.path,v.OBJ_IMAGE,e.size,e.name,e.resStore,e.cosBucket)},createImageTextMessage:function(e){var n=Number(e.to);if(!isNaN(n)){M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:4,str_log:"[c-imsdk_createImageTextMessage][".concat(n,"]")}]}}),d({module:"c-imsdk",method:"createImageTextMessage",from:s,to:n,message:{payload:e.payload}});var o=e.payload||{imageText:""},a=e.payload.user_id,r=e.payload.user_type,_=e.payload.pubacc_id,c="",u=i.get(n);return u&&u.extend&&(a=u.extend.str_user_id||a,r=u.extend.user_type||r,c=u.extend.str_session_id||c,_=u.extend.uint64_pubacc_id||_),w.createImageTextMessage({aid:n,crm_user_type:r,str_cid:a,str_session_id:c,uint64_pubacc_id:_},o.imageText)}g("消息接收方(to)不是数值类型",e.to)},createQDXMLMessage:function(e){var n=Number(e.to);if(!isNaN(n)){M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:4,str_log:"[c-imsdk_createQDXMLMessage][".concat(n,"]")}]}}),d({module:"c-imsdk",method:"createQDXMLMessage",from:s,to:n,message:{payload:e.payload}});var o=e.payload||{qdXml:""},a=e.payload.user_id,r=e.payload.user_type,_=e.payload.pubacc_id,c="",u=i.get(n);return u&&u.extend&&(a=u.extend.str_user_id||a,r=u.extend.user_type||r,c=u.extend.str_session_id||c,_=u.extend.uint64_pubacc_id||_),w.createQDXMLMessage({aid:n,crm_user_type:r,str_cid:a,str_session_id:c,uint64_pubacc_id:_},o.qdXml,o.crmData)}g("消息接收方(to)不是数值类型",e.to)},createVoiceMessage:function(e){var n=Number(e.to);if(!isNaN(n)){M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:4,str_log:"[c-imsdk_createVoiceMessage][".concat(n,"]")}]}}),d({module:"c-imsdk",method:"createVoiceMessage",from:s,to:n,message:{payload:e.payload}});var o=e.payload||{file:{}},a=e.payload.user_id,r=e.payload.user_type,_=e.payload.pubacc_id,c="",u=i.get(n);return u&&u.extend&&(a=u.extend.str_user_id||a,r=u.extend.user_type||r,c=u.extend.str_session_id||c,_=u.extend.uint64_pubacc_id||_),w.createPttMessage({aid:n,crm_user_type:r,str_cid:a,str_session_id:c,uint64_pubacc_id:_},o.ptt)}g("消息接收方(to)不是数值类型",e.to)},createFileMessage:function(e){var n=Number(e.to);if(!isNaN(n)){M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:4,str_log:"[c-imsdk_createFileMessage][".concat(n,"]")}]}}),d({module:"c-imsdk",method:"createFileMessage",from:s,to:n,message:{payload:e.payload}});var o=e.payload||{file:{}},a=e.payload.user_id,r=e.payload.user_type,_=e.payload.pubacc_id,c="",u=i.get(n);return u&&u.extend&&(a=u.extend.str_user_id||a,r=u.extend.user_type||r,c=u.extend.str_session_id||c,_=u.extend.uint64_pubacc_id||_),w.createFileMessage({aid:n,crm_user_type:r,str_cid:a,str_session_id:c,uint64_pubacc_id:_},o.file)}g("消息接收方(to)不是数值类型",e.to)},createFileUploadMessage:function(e,n){return M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:4,str_log:"[c-imsdk_createFileUploadMessage]"}]}}),d({module:"c-imsdk",method:"createFileUploadMessage",from:s,message:""}),w.createMsgUploadReq(n||v.OBJ_FILE,e.size,e.name,"string"===typeof e.method&&"post"===e.method.toLowerCase(),e.resStore)},createFileDownloadMessage:function(e,n){return M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:4,str_log:"[c-imsdk_createFileDownloadMessage][".concat(e.path,"]")}]}}),d({module:"c-imsdk",method:"createFileDownloadMessage",from:s,message:{path:e.path}}),w.createMsgDownloadReq(e.path,n||v.OBJ_FILE,e.size||0,e.name||"",e.resStore,e.cosBucket)},createLongTextMessage:function(e){var n=Number(e.to);if(!isNaN(n)){M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:4,str_log:"[c-imsdk_createLongTextMessage][".concat(n,"]")}]}}),d({module:"c-imsdk",method:"createLongTextMessage",from:s,to:n,message:{payload:e.payload}});var o=e.payload||{long_msg:{}},a=e.payload.user_id,r=e.payload.user_type,_=e.payload.pubacc_id,c="",u=i.get(n);return u&&u.extend&&(a=u.extend.str_user_id||a,r=u.extend.user_type||r,c=u.extend.str_session_id||c,_=u.extend.uint64_pubacc_id||_),w.createLongTextMessage({aid:n,crm_user_type:r,str_cid:a,str_session_id:c,uint64_pubacc_id:_},o.long_msg,o.crmData)}g("消息接收方(to)不是数值类型",e.to)},sendMessage:function(n){var o=this;return this.sessionStarted?(d({module:"c-imsdk",method:"[sendMessage][request]",from:s,message:n}),t.send({uint32_sub_command:e.MESSAGE_TYPE.MESSAGE},n).then((function(e){var n=w.unpackMsgSendRsp(e);if(n.syncseq-_==1){if(_=n.syncseq,i.has(n.to)){var a=i.get(n.to);if(a.seq=Math.max(a.seq,n.seq||0),a.msgtime=n.time,a.unread=1,n.content.length>0){var r=n.content[0];a.summary=o.createMessageSummary(r)}o.setMessageRead({to:n.to})}}else o.sendSyncMessage(_+1,[]);return f("发送消息回包:",e),M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:4,str_log:"[c-imsdk_sendMessage_rsp][".concat(JSON.stringify(n),"]")}]}}),d({module:"c-imsdk",method:"[sendMessage][response]",from:s,message:n}),n})).catch((function(e){throw g("发送消息超时:",e),M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:2,str_log:"[c-imsdk_sendMessage_tiemout]"}]}}),d({module:"c-imsdk",method:"[sendMessage][timeout]",from:s,message:{err:e,message:n}}),{reason:e.result,seq:e.seq}}))):(d({module:"c-imsdk",method:"[sendMessage][error]",from:s,message:"not-sessionStarted"}),Promise.resolve({code:-9999,error:"接入会话失败，无法发送消息"}))},resendMessage:function(e){var n=this;return this.sessionStarted?(d({module:"c-imsdk",method:"[resendMessage][request]",from:s,message:{resendSeq:e}}),t.resend(e).then((function(o){var a=w.unpackMsgSendRsp(o);if(a.syncseq-_==1){if(_=a.syncseq,i.has(a.to)){var r=i.get(a.to);if(r.seq=Math.max(r.seq,a.seq||0),r.msgtime=a.time,r.unread=1,a.content.length>0){var c=a.content[0];r.summary=n.createMessageSummary(c)}n.setMessageRead({to:a.to})}}else n.sendSyncMessage(_+1,[]);return f("重发消息回包:",o),M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:4,str_log:"[c-imsdk_resendMessage_rsp][".concat(JSON.stringify(a),"]")}]}}),d({module:"c-imsdk",method:"[resendMessage][response]",from:s,message:{resendSeq:e,result:a}}),a})).catch((function(n){throw g("重发消息超时:",n),M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:2,str_log:"[c-imsdk_resendMessage_tiemout]"}]}}),d({module:"c-imsdk",method:"[resendMessage][timeout]",from:s,message:{resendSeq:e,err:n}}),{reason:n.result,seq:n.seq}}))):(d({module:"c-imsdk",method:"resendMessage",from:s,message:"[error]not-sessionStarted"}),Promise.reject())},revokeMessage:function(n){f("撤回消息",n);var o=Number(n.to),a=n.payload.user_id,r=n.payload.user_type,_=n.payload.pubacc_id,c="",u=i.get(o);u&&u.extend&&(a=u.extend.str_user_id||a,r=u.extend.user_type||r,c=u.extend.str_session_id||c,_=u.extend.uint64_pubacc_id||_);var m=n.payload.message,p=w.createRevokeMessage({aid:o,crm_user_type:r,str_cid:a,str_session_id:c,uint64_pubacc_id:_},{uint64_msg_roaming_seq:m.seq,uint64_msg_sync_seq:m.syncseq,uint64_side_sync_seq:m.sidesyncseq,uint64_msg_time:1e3*m.time});return d({module:"c-imsdk",method:"[revokeMessage][request]",from:s,message:p}),t.send({uint32_sub_command:e.MESSAGE_TYPE.MESSAGE},p).then((function(e){var n=w.unpackMsgSendRsp(e);return f("撤回消息回包:",e),M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:4,str_log:"[c-imsdk_revokeMessage_rsp][".concat(JSON.stringify(n),"]")}]}}),d({module:"c-imsdk",method:"[revokeMessage][response]",from:s,message:n}),n})).catch((function(e){throw g("撤回消息超时:",e),M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:2,str_log:"[c-imsdk_revokeMessage_tiemout]"}]}}),d({module:"c-imsdk",method:"[revokeMessage][timeout]",from:s,message:e}),{reason:e.result,seq:e.seq}}))},onMessageNotify:function(e){if(f("同步消息推送",e),u){var n=w.unpackNewMsgNotice(e.message);if(M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:4,str_log:"[c-imsdk_onMessageNotify][sync_seq:".concat(_,"][seq:").concat(n,"]")}]}}),d({module:"c-imsdk",method:"onMessageNotify",from:s,message:{localseq:_,msgseq:n}}),_>n||O)return void(T=Math.max(T,n));q=Math.max(S,--q),E.sendSyncMessage(_+1,[])}},sendSyncMessage:function(o){var r=this,c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if(M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:4,str_log:"[c-imsdk_sendSyncMessage_req][".concat(o,"]")}]}}),O=!0,d({module:"c-imsdk",method:"[sendSyncMessage][request]",from:s,message:{seq:o}}),0===c.length){clearTimeout(m);var u=h/Math.pow(2,q);if(q>=x){var p=1e4,v=3e3;u=Math.round(v+Math.random()*(p-v)),d({module:"c-imsdk",method:"[sendSyncMessage][warning]",from:s,message:{seq:o}})}m=setTimeout((function(){r.sendSyncMessage(_+1,[]),q=Math.min(x,++q)}),u)}var k=w.createSyncMessage(o,this.config.syncMsgSize);t.send({uint32_sub_command:e.MESSAGE_TYPE.SYNC_MESSAGE},k).then((function(e){f("同步消息回包:",e),d({module:"c-imsdk",method:"[sendSyncMessage][response][success]",from:s});var u=w.unpackMsgSyncRsp(e);if(u.length>0)for(var m=0;m<u.length;m++){var p=u[m];if(p.syncseq-_==1){if(c.push(p),_=p.syncseq,l.has(p.syncseq)&&l.delete(p.syncseq),d({module:"c-imsdk",method:"[sendSyncMessage][response][push]",from:s,message:{msgseq:p.syncseq}}),p.type===b.MSG_GRAY)try{var h=p.crm.msg_webim_extra_data.uint64_extuin;h&&r.getReceptionStatus()}catch(B){}}else{if(p.syncseq-_>1){var v=_+1;if(l.has(v)){var k=l.get(v);k>=2&&(_=v,d({module:"c-imsdk",method:"[sendSyncMessage][response][hole-lost]",from:s,message:{msgseq:p.syncseq,skipseq:_}})),l.set(v,++k)}else l.set(v,1),d({module:"c-imsdk",method:"[sendSyncMessage][response][hole]",from:s,message:{msgseq:p.syncseq,localseq:_}});u=u.slice(0,m),setTimeout((function(){r.sendSyncMessage&&r.sendSyncMessage(_+1,[])}),1e3),f("同步消息回包[空洞hole]:",p.syncseq),M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:4,str_log:"[c-imsdk_sendSyncMessage_req][hole][".concat(p.syncseq,"]")}]}});break}f("-----------\x3esame-seq!",p.syncseq,_),d({module:"c-imsdk",method:"[sendSyncMessage][response][repeat]",from:s,message:{syncseq:p.syncseq}})}}else q=Math.max(S,--q);if(u.length<r.config.syncMsgSize){var x,E={},R=Object(a["a"])(c);try{for(R.s();!(x=R.n()).done;){var D=x.value;if(D.content||D.path){var I=D.from;D.from==s&&(I=D.to),E[I]=E[I]||[],E[I].push(D);var N=r.createMessageSummary(D);if(i.has(I)){var C=i.get(I);D.seq>C.seq&&(C.summary=N,C.seq=D.seq,C.unread+=1,C.msgtime=D.time,D.crm&&(C.extend.str_session_id="",C.extend.str_user_id=D.crm["str_cid"],C.extend.user_type=D.crm["crm_user_type"],C.extend.uint64_pubacc_id=D.crm["uint64_pubacc_id"]||0))}else{var A={context:"",id:I,type:0,summary:N,seq:D.seq,unread:1,msgtime:D.time,block:0,top:0,toptime:0,extend:{}};D.crm&&(A.extend={str_session_id:"",str_user_id:D.crm["str_cid"],user_type:D.crm["crm_user_type"],uint64_pubacc_id:D.crm["uint64_pubacc_id"]||0}),i.set(I,A)}}else d({module:"c-imsdk",method:"[sendSyncMessage][response][empty]",from:s,message:D})}}catch(z){R.e(z)}finally{R.f()}if(c.length>0){n.emit(y.MESSAGE_RECEIVED,E);var j={};try{Object.keys(E).forEach((function(e){var t=E[e];j[e]=[],t.forEach((function(t){j[e].push({seq:t.syncseq,content:t.content,path:t.path,from:t.from,to:t.to})}))}))}catch(B){g(B)}f("receivedMsg",j),d({module:"c-imsdk",method:"MESSAGE_RECEIVED",from:s,message:{receivedMsg:j}}),r.updateUnReadMessage()}f("sync_message_array",c),O=!1,T>_&&r.sendSyncMessage(_+1,[])}else r.sendSyncMessage(_+1,c);var G,L=[],P=Object(a["a"])(u);try{for(P.s();!(G=P.n()).done;){var U=G.value;L.push({seq:U.seq,syncseq:U.syncseq,from:U.from,to:U.to,time:U.time,type:U.type||""})}}catch(z){P.e(z)}finally{P.f()}M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:4,str_log:"[c-imsdk_sendSyncMessage_rsp][".concat(o,"][").concat(JSON.stringify(L),"]")}]}}),d({module:"c-imsdk",method:"[sendSyncMessage][response][done]",from:s,message:{seq:o,msginfo:L}})})).catch((function(e){O=!1,g("同步消息超时:",e),M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:2,str_log:"[c-imsdk_sendSyncMessage_timeout][".concat(o,"]")}]}}),d({module:"c-imsdk",method:"[sendSyncMessage][timeout]",from:s,message:{seq:o,err:e}})}))},createMessageSummary:function(e){var t="[未知消息类型]";if(e.type==b.MSG_TEXT)t=e.content.substr(0,20);else if(e.type==b.MSG_FACE)t="[表情]";else if(e.type==b.MSG_MEDIA)t="[资源链接]";else if(e.type==b.MSG_IMAGE)t="[图片]";else if(e.type==b.MSG_VOICE)t="[语音]";else if(e.type==b.MSG_LONG_MSG)t="[长文本]";else if(e.type==b.MSG_IMAGE_TEXT)t="[图文]";else if(e.type==b.MSG_QDXML)t="[卡片]";else if(e.type==b.MSG_FILE)t="[文件]";else if(e.type==b.MSG_GRAY)t="[其他消息]";else if(e.type==b.MSG_REVOKE)t=e.from==s?"你撤回了一条消息":"对方撤回了一条消息";else if(e.type==b.MSG_MIX){var n=e.content[0];n.type==b.MSG_TEXT?t=n.content.substr(0,20):n.type==b.MSG_FACE?t="[表情]":n.type==b.MSG_MEDIA?t="[资源链接]":n.type==b.MSG_IMAGE&&(t="[图片]")}else e.type==b.MSG_RTC&&(t="".concat(e.content.str_text_msg,"-").concat(e.content.uint32_video_status_type));return t},getMessageList:function(n){var o=this,a=Number(n.to),r=Number(n.seq),_=n.payload;if(!isNaN(a)&&!isNaN(r)){if(d({module:"c-imsdk",method:"[getMessageList][request]",from:s,message:{to:a,seq:r}}),r<0&&(r=Number.MAX_SAFE_INTEGER),i.has(a)){var c=i.get(a);c.extend.str_user_id&&c.extend.user_type||(c.extend.str_user_id=_.user_id,c.extend.user_type=_.user_type||this.config.channelType,c.extend.uint64_pubacc_id=_.pubacc_id)}else{var u={context:"",id:a,type:0,summary:"",seq:0,unread:0,msgtime:Date.now(),block:0,top:0,toptime:0,extend:{str_session_id:"",str_user_id:_.user_id,user_type:_.user_type||this.config.channelType,uint64_pubacc_id:_.pubacc_id}};i.set(a,u)}return new Promise((function(n,i){var _=w.createMsgRoamingReq(a,r,o.config.roamingMsgSize);t.send({uint32_sub_command:e.MESSAGE_TYPE.ROAMING_MESSAGE},_).then((function(e){var i=[];e["msg_roaming_rsp"]&&(i=w.unpackMsgRoamingRsp(e),i.length>0&&(r=i[i.length-1].seq-1)),n({messageList:i,nextReqMessageSeq:r,isCompleted:i.length<o.config.roamingMsgSize}),f("漫游消息回包:",e);var _=[];if(i.length>0){var c=i[i.length-1],u=i[0];_.push({int64_min_roaming_id:u.seq,int64_max_roaming_id:c.seq,int64_from_id:c.from,int64_to_id:c.to,int64_msg_send_time:1e3*c.time,int64_user_login_time:e.login_time,int64_msg_recv_server_time:e.timestamp,uint64_gseq:e.gseq})}M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},roaming_event:_,log_event:[{log_level:4,str_log:"[c-imsdk_getMessageList_rsp][".concat(a,"][").concat(r,"]")}]}}),d({module:"c-imsdk",method:"[getMessageList][response]",from:s,to:a,message:{to:a,seq:r,msginfo:_}})})).catch((function(e){throw g("漫游消息超时:",e),M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:2,str_log:"[c-imsdk_getMessageList_timeout][".concat(a,"][").concat(r,"]")}]}}),d({module:"c-imsdk",method:"[getMessageList][tiemout]",from:s,message:e}),{reason:e.result,seq:e.seq}}))}))}g("消息接收方(to)或者起始seq不是数值类型",n.to,n.seq)},getSDKMessageList:function(n){var i=this,o=Number(n.toAid),a=Number(n.appid),r=String(n.openid),_=Number(n.seq);n.payload;if(isNaN(o)||isNaN(_))g("消息接收方(to)或者起始seq不是数值类型",n.to,n.seq);else{if(!isNaN(a)&&r)return d({module:"c-imsdk",method:"[getSDKMessageList][request]",from:s,message:{toAid:o,openid:r,seq:_}}),_<0&&(_=Number.MAX_SAFE_INTEGER),new Promise((function(n,c){var u=w.createSDKMsgRoamingReq(a,r,o,_,i.config.roamingMsgSize);t.send({uint32_sub_command:e.MESSAGE_TYPE.ROAMING_MESSAGE},u).then((function(e){var a=[];e["msg_roaming_rsp"]&&(a=w.unpackMsgRoamingRsp(e),a.length>0&&(_=a[a.length-1].seq-1)),n({messageList:a,nextSDKReqMessageSeq:_,isCompleted:a.length<i.config.roamingMsgSize}),f("漫游消息回包:",e);var c=[];if(a.length>0){var u=a[a.length-1],m=a[0];c.push({int64_min_roaming_id:m.seq,int64_max_roaming_id:u.seq,int64_from_id:u.from,int64_to_id:u.to,int64_msg_send_time:1e3*u.time,int64_user_login_time:e.login_time,int64_msg_recv_server_time:e.timestamp,uint64_gseq:e.gseq})}M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},roaming_event:c,log_event:[{log_level:4,str_log:"[c-imsdk_getSDKMessageList_rsp][".concat(o,"][").concat(_,"]")}]}}),d({module:"c-imsdk",method:"[getSDKMessageList][response]",from:s,to:o,message:{toAid:o,seq:_,openid:r,msginfo:c}})})).catch((function(e){throw g("漫游消息超时:",e),M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:2,str_log:"[c-imsdk_getSDKMessageList_timeout][".concat(o,"][").concat(_,"]")}]}}),d({module:"c-imsdk",method:"[getSDKMessageList][tiemout]",from:s,message:e}),{reason:e.result,seq:e.seq}}))}));g("消息接收方appid或者openid或者appid为空",a,r)}},sendContactMessage:function(){var o=this,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",m=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;d({module:"c-imsdk",method:"[sendContactMessage][request]",from:s,message:m});var p=w.createMsgContactReq(r,m,this.config.contactMsgSize);t.send({uint32_sub_command:e.MESSAGE_TYPE.CONTACT_MESSAGE},p).then((function(e){f("全体未读消息回包:",e);var t=w.unpackMsgContactRsp(e);r=t.str_data_context,_<=0&&(_=t.uint64_max_sync_seq||0);var g=t.contact;if(g.length>0&&(c=c.concat(g)),g.length<o.config.contactMsgSize){f("_contact_message_array",c);var p,l=Object(a["a"])(c);try{for(l.s();!(p=l.n()).done;){var h=p.value;i.set(h.id,h)}}catch(b){l.e(b)}finally{l.f()}u=!0,o.updateUnReadMessage(),o.sendSyncMessage(_+1,[]),n.emit(y.SDK_READY),d({module:"c-imsdk",method:"[sendContactMessage][response]",from:s,message:t})}else o.sendContactMessage(r,m+o.config.contactMsgSize)})).catch((function(e){g("全体未读消息超时:",e),d({module:"c-imsdk",method:"[sendContactMessage][timeout]",from:s,message:"timeout"})}))},setMessageRead:function(n){var o=Number(n.to);if(i.has(o)){var a=i.get(o);if(0!=a.unread)return a.unread=0,M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:4,str_log:"[c-imsdk_setMessageRead_req][".concat(a.id,"][").concat(a.seq,"]")}]}}),d({module:"c-imsdk",method:"[setMessageRead][request]",from:s,message:{id:a.id,seq:a.seq}}),new Promise((function(n,i){var o=w.createMsgReadReq(a.id,0,a.seq);t.send({uint32_sub_command:e.MESSAGE_TYPE.READ_MESSAGE},o).then((function(e){var i=w.unpackMsgReadRsp(e);n(i),f("已读上报消息回包:",e),M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:4,str_log:"[c-imsdk_setMessageRead_rsp][".concat(a.id,"][").concat(a.seq,"]")}]}}),d({module:"c-imsdk",method:"[setMessageRead][response]",from:s,message:{id:a.id,seq:a.seq}})})).catch((function(e){g("已读上报消息超时:",e),M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:2,str_log:"[c-imsdk_setMessageRead_timeout][".concat(a.id,"][").concat(a.seq,"]")}]}}),d({module:"c-imsdk",method:"[setMessageRead][timeout]",from:s,message:{id:a.id,seq:a.seq}})}))}))}},updateUnReadMessage:function(){var e=[];if(i.forEach((function(t){t.unread>0&&e.push({id:t.id,content:t.summary,time:t.msgtime,unread:t.unread,extend:{user_type:t.extend&&t.extend.user_type,user_id:t.extend&&t.extend.str_user_id}})})),e.length>0){n.emit(y.MESSAGE_UNREAD_UPDATED,e);var o,r=[],_=Object(a["a"])(e);try{for(_.s();!(o=_.n()).done;){var c=o.value;r.push({id:c.id,unread:c.unread})}}catch(u){_.e(u)}finally{_.f()}M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:4,str_log:"[c-imsdk_updateUnReadMessage][".concat(JSON.stringify(r),"]")}]}}),d({module:"c-imsdk",method:"updateUnReadMessage",from:s,message:{msginfo:r}})}},sendUploadOrDownloadMessage:function(n){return d({module:"c-imsdk",method:"[sendUploadOrDownloadMessage][request]",from:s,message:n}),t.send({uint32_sub_command:e.MESSAGE_TYPE.PRESIGNED_URL},n).then((function(e){var n=w.unpackMsgUploadOrDownloadRsp(e);return f("文件上传/下载回包:",e),M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:4,str_log:"[c-imsdk_sendUploadOrDownloadMessage_rsp][".concat(JSON.stringify(n),"]")}]}}),d({module:"c-imsdk",method:"[sendUploadOrDownloadMessage][response]",from:s,message:n}),n})).catch((function(e){throw g("文件上传/下载超时:",e),M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:2,str_log:"[c-imsdk_sendUploadOrDownloadMessage_timeout]"}]}}),d({module:"c-imsdk",method:"[sendUploadOrDownloadMessage][tiemout]",from:s,message:e}),{reason:e.result,seq:e.seq}}))},clientIncoming:function(e){var t=this,i=w.createMsgClientIncomingReq(e),o=setTimeout((function(){n.emit(y.LOCAL_NOTIFY,{type:"session_start_timeout",content:"会话接入超时"}),d({module:"c-imsdk",method:"[clientIncoming][timeout]",from:s,message:"timeout"})}),6e4);d({module:"c-imsdk",method:"[clientIncoming][request]",from:s,message:e}),this.sendCmdMessage(325001,i).then((function(e){clearTimeout(o),d({module:"c-imsdk",method:"[clientIncoming][response]",from:s,message:e});var i=e.msg_ret_info,a=void 0===i?{}:i,r=e.msg_handle_incoming_msq_rsp,_=a.uint32_ret_code,c=a.str_error_msg,u={};if(_>=0){if(d({module:"c-imsdk",method:"[clientIncoming][response][success]",from:s,message:{code:_,msginfo:a}}),19===_)u={inWaitPool:!0};else if(r){f("[clientIncoming]",r);var m=r.bool_is_robot,g=r.uint64_robot_id,p=r.uint64_kfextuin,l=r.uint32_robot_type;u=1===l&&m?{isLargeModelRobot:!0,largeModelRobotId:g}:m?{isRobot:!0,robotId:g}:{extuin:p}}t.updateReception(u),t.sessionStarted=!0,n.emit(y.SESSION_START)}else n.emit(y.LOCAL_NOTIFY,{type:"session_start_error",content:c||"会话失败 (code:".concat(_,")")}),d({module:"c-imsdk",method:"[clientIncoming][response][error]",from:s,message:{code:_}})}))},c2bSessionStart:function(e){var t=this,i=w.createC2bSessionStartReq(e),o=setTimeout((function(){n.emit(y.LOCAL_NOTIFY,{type:"session_start_timeout",content:"会话接入超时"})}),6e4);d({module:"c-imsdk",method:"[c2bSessionStart][request]",from:s,message:e}),this.sendCmdMessage(125603,i).then((function(e){clearTimeout(o),d({module:"c-imsdk",method:"[c2bSessionStart][response]",from:s,message:e});var i=e.msg_c2b_session_start_rsp,a=void 0===i?{}:i,r=a.msg_ret,_=void 0===r?{}:r,c=a.msg_session_data,u=_.uint32_ret_code,m=_.str_error_msg,g={};if(u>=0){if(19===u)g={inWaitPool:!0};else if(c){f("[sessionStart]",c);var p=c.bool_is_robot,l=c.uint64_robot_id,h=c.uint64_kfextuin,b=c.uint32_robot_type;g=1===b&&p?{isLargeModelRobot:!0,largeModelRobotId:l}:p?{isRobot:!0,robotId:l}:{extuin:h}}t.updateReception(g),t.sessionStarted=!0,n.emit(y.SESSION_START)}else n.emit(y.LOCAL_NOTIFY,{type:"session_start_error",content:m||"会话失败 (code:".concat(u,")")})}))},sendInnerClickEvent:function(e){var t=w.createMsgQdmenuReq(e);return d({module:"c-imsdk",method:"[sendInnerClickEvent][request]",from:s,message:e}),this.sendCmdMessage(303155,t).then((function(e){return d({module:"c-imsdk",method:"[sendInnerClickEvent][response]",from:s,message:e}),f("[sendInnerClickEvent]",e),e}))},closeSession:function(e){var t=this,n=w.createMsgCloseSessiongReq(e);d({module:"c-imsdk",method:"[closeSession][request]",from:s,message:e}),this.sendCmdMessage(201017,n).then((function(e){if(d({module:"c-imsdk",method:"[closeSession][response]",from:s,message:e}),e.msg_customer_closeSession_req){f("[closeSession]",e.msg_customer_closeSession_req);var n=e.msg_customer_closeSession_req;n.msg_ret&&!n.msg_ret.uint32_ret_code&&t.updateReception({})}return e}))},fetchExtuinInfo:function(e,t){var n=this;return d({module:"c-imsdk",method:"[fetchExtuinInfo][request]",from:s,message:e}),new Promise(t?function(t,i){var o={robotids:[e.extuin],kfuin:+e.kfuin};n.sendCmdMessage(4,o,1536).then((function(e){var n=JSON.parse(e);if(d({module:"c-imsdk",method:"[fetchExtuinInfo][response]",from:s,message:e}),0===n.code){f("[fetchExtuinInfo-rsp]",n.data);try{var i=n.data.robotInfo[0]||{},o=i.name,a=i.avatar;t({name:o,avatar:a})}catch(r){t(null)}}t(null)})).catch((function(){t(null)}))}:function(t,i){var o=w.createMsgGetCustomerDetailReq(e);n.sendCmdMessage(303002,o).then((function(e){if(d({module:"c-imsdk",method:"[fetchExtuinInfo][response]",from:s,message:e}),e.msg_inner_get_customer_detail_data_rsp&&e.msg_inner_get_customer_detail_data_rsp.msg_customer_data_rsp&&e.msg_inner_get_customer_detail_data_rsp.msg_customer_data_rsp.msg_staff_data){f("[fetchExtuinInfo-rsp]",e.msg_inner_get_customer_detail_data_rsp.msg_customer_data_rsp.msg_staff_data);var n=e.msg_inner_get_customer_detail_data_rsp.msg_customer_data_rsp.msg_staff_data,i=n.string_external_name,o=n.string_external_face,a=n.string_user_name;t({name:i,avatar:o,innerName:a})}t(null)})).catch((function(){t(null)}))})},sendCmdMessage:function(e,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1064;return d({module:"c-imsdk",method:"sendCmdMessage",from:s,message:{command:e,msgtype:i,message:n}}),t.send({uint32_sub_command:e,uint32_sub_msgtype:i},n)},on:function(e,t){u&&e==y.SDK_READY?t&&t():n.on(e,t)},off:function(e,t){n.off(e,t)},emit:function(e,t){n.emit(e,t)},setLogReport:function(e){d=e},setMessageTags:function(e,t){var n=e.msgHead,i=n.uint64_msg_roaming_seq,o=n.msg_type_info,a=o.msg_c2c_info.uint64_from_aid,r=o.msg_c2c_info.uint64_to_aid,_=t.map((function(e){return{str_tag:e.tag,bytes_value:e.value}})),c={from:a,to:r,roamingId:i,tags:_},u=w.createUpdateOnlineReq(c);d({module:"c-imsdk",method:"[setMessageTags][request]",from:s,message:c}),this.sendCmdMessage(324035,u,1297).then((function(e){return f("[setMessageTags]",e),d({module:"c-imsdk",method:"[setMessageTags][response]",from:s,message:e}),e}))},getMessageTags:function(e){var t=e.msgBody||{},n=t.msg_tags,i=void 0===n?[]:n,s=i.map((function(e){return{tag:e.str_tag||e.name,value:e.bytes_value}}));return s},setCustomerInfo:function(e){var t=this,n={};Object.keys(e).forEach((function(t){"gender"===t?n["uint32_"+t]=e[t]:n["bytes_"+t]=e[t]}));var i=w.createSetAidInfoReq(n);return d({module:"c-imsdk",method:"[setCustomerInfo][request]",from:s,message:e}),new Promise((function(e,n){t.sendCmdMessage(324028,i).then((function(t){if(d({module:"c-imsdk",method:"[setCustomerInfo][response]",from:s,message:t}),t.msg_ret_info){var i=t.msg_ret_info,o=i.uint32_ret_code,a=i.str_error_msg;o?n({code:o,message:a}):e(!0)}else n({code:-1,message:"操作失败，请重试"})})).catch((function(){n({code:-1,message:"操作失败，请重试"})}))}))},activeFeedback:function(e){var t=this,n=w.createActiveFeedbackReq(e);return d({module:"c-imsdk",method:"[activeFeedback][request]",from:s,message:e}),new Promise((function(e,i){t.sendCmdMessage(215100,n).then((function(t){if(d({module:"c-imsdk",method:"[activeFeedback][response]",from:s,message:t}),t.msg_push_satisfaction_survey_all_channel_rsp){var n=t.msg_push_satisfaction_survey_all_channel_rsp,o=n.msg_ret,a=void 0===o?{}:o,r=a.uint32_ret_code,_=a.str_error_msg;r?i({code:r,message:_}):e(!0)}else i({code:-1,message:"操作失败，请重试"})})).catch((function(e){i({code:-1,message:"操作失败，请重试"})}))}))},createCompressedLongTextDownloadMessage:function(e,n){return M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:4,str_log:"[c-imsdk_createCompressedLongTextDownloadMessage][".concat(e.path,"]")}]}}),d({module:"c-imsdk",method:"createCompressedLongTextDownloadMessage",from:s,message:e}),Object.assign(e,{kfuin:t.config.kfuin,appid:t.config.appid}),w.createCompressedLongTextMsgDownloadReq(e,n)},createCompressedSDKLongTextDownloadMessage:function(e,n){return M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:4,str_log:"[c-imsdk_createCompressedSDKLongTextDownloadMessage][".concat(e.path,"]")}]}}),d({module:"c-imsdk",method:"createCompressedSDKLongTextDownloadMessage",from:s,message:e}),Object.assign(e,{kfuin:t.config.kfuin,appid:e.sdkAppid||t.config.appid}),Object.assign(w.createCompressedLongTextMsgDownloadReq(e,n),{cos_bucket:e.cosBucket||1})},createExitQueueMessage:function(e){return M({report_content:{common_head:{uint64_kfuin:t.config.kfuin,uint64_aid:t.config.aid,uint64_client_time:(new Date).getTime(),uint32_client_type:t.config.client_type,uint32_appid:t.config.appid,str_client_version:"1.0.0"},log_event:[{log_level:4,str_log:"[c-imsdk_createExitQueueMessage][".concat(JSON.stringify(e),"]")}]}}),d({module:"c-imsdk",method:"createExitQueueMessage",from:s,message:e}),w.createExitQueueMessage(e)},getOldMessageList:function(e){var n=this,i=Number(e.to),o=Number(e.end);e.payload;if(!isNaN(i)&&!isNaN(o))return d({module:"c-imsdk",method:"[getOldMessageList][request]",from:s,message:{to:i,end:o}}),o<0&&(o=1e3*Date.now()),new Promise((function(e,a){var r=w.createOldMsgRoamingReq(i,o,n.config.roamingMsgSize);t.send({uint32_sub_command:325004,uint32_sub_msgtype:1064},r).then((function(t){var a=[];t["webim_roaming_adapted_rsp"]&&(a=w.unpackMsgRoamingRsp(t),a.length>0&&(o=1e3*a[a.length-1].time+1)),e({messageList:a,nextReqMessageTime:o,isCompleted:a.length<n.config.roamingMsgSize,isOldRoamingMsg:!0}),f("漫游消息回包:",t);var r=[];if(a.length>0){var _=a[a.length-1],c=a[0];r.push({int64_min_roaming_id:c.seq,int64_max_roaming_id:_.seq,int64_from_id:_.from,int64_to_id:_.to,int64_msg_send_time:1e3*_.time,int64_user_login_time:t.login_time,int64_msg_recv_server_time:t.timestamp,uint64_gseq:t.gseq})}d({module:"c-imsdk",method:"[getOldMessageList][response]",from:s,to:i,message:{to:i,end:o,msginfo:r}})})).catch((function(e){throw g("漫游消息超时:",e),d({module:"c-imsdk",method:"[getOldMessageList][tiemout]",from:s,message:e}),{reason:e.result,seq:e.seq}}))}));g("消息接收方(to)或者起始end不是数值类型",e.to,e.end)},getReceptionStatus:function(){var e=this;d({module:"c-imsdk",method:"[getReceptionStatus][request]",from:s});var n=w.createMsgSessionGetReq({cid:t.config.aid});return this.sendCmdMessage(201701,n).then((function(t){try{var n=t.msg_session_get_rsp.msg_data;d({module:"c-imsdk",method:"[getReceptionStatus][response]",from:s,message:n}),f("[getReceptionStatus]",n);var i={},o=n.bool_is_robot,a=n.uint64_robot_id,r=n.msg_kfext_info,_=n.uint32_status,c=n.uint32_robot_type;if(_)if(1===c&&o)i={isLargeModelRobot:!0,largeModelRobotId:a};else if(o)i={isRobot:!0,robotId:a};else if(r){var u=r.uint64_kfextuin;u&&(i={extuin:u})}Object.keys(i).length>0&&e.updateReception(i)}catch(m){g(m)}}))},updateReception:function(e){JSON.stringify(p)!==JSON.stringify(e)?(p=e,f("[updateReception]","11111111",p),n.emit(y.RECEPTION_CHANGE,p)):f("[updateReception]","00000000",p)},getSocket:function(){return t},createReportMsgReadReportReq:function(e){console.log("[createReportMsgReadReportReq]",e);var t=w.createReportMsgReadReportReq(e);return t},createGetMsgReadInfoReq:function(e){console.log("[createGetMsgReadInfoReq]",e);var t=w.createGetMsgReadInfoReq(e);return t},pushMsgReadReport:function(e){d({module:"c-imsdk",method:"[pushMsgReadReport][request]",from:s,message:e}),console.log("[pushMsgReadReport]",e);var t=370010,n=w.createReportMsgReadReportReq(e);return this.sendCmdMessage(t,n).then((function(e){return d({module:"c-imsdk",method:"[pushMsgReadReport][response]",from:s,message:e}),e}))},getMessageCrmData:function(e){try{var t=e.msg_send_req.msg_send_msg.msg_msg_head.msg_third_app_info.bytes_third_app_buf.bytes_crm_buf;return t}catch(n){g("[getMessageCrmData]",n)}return{}},setMessageCrmData:function(e,t){var n=this.getMessageCrmData(e);try{return e.msg_send_req.msg_send_msg.msg_msg_head.msg_third_app_info.bytes_third_app_buf.bytes_crm_buf=Object(o["a"])(Object(o["a"])({},n),t),e}catch(i){g("[setMessageCrmData]",i)}return e},getConnectConfig:function(){return t&&t.config?t.config:{}},sendInputStatusMessage:function(e,t){var n=1064,i=310750,o=e.user_type;4===o?o=3:2===o?o=1:6===o&&(o=11);var a={inner_input_status_sync_req:{uint64_to_uin:e.extuin,uint64_from_uin:s,uint64_kfuin:e.id,uint32_channel:o,string_union_cid:e.user_id,uint32_ime:0,uint32_event_type:t,uint32_dir:1}};this.sendCmdMessage(i,a,n).then((function(e){return f("sendInputStatusMessage",e),d({module:"c-imsdk",method:"[sendInputStatusMessage][response]",from:s,message:e}),e}))}};return E}(function(e){e["SDK_READY"]="SDK_READY",e["MESSAGE_RECEIVED"]="MESSAGE_RECEIVED",e["MESSAGE_UNREAD_UPDATED"]="MESSAGE_UNREAD_UPDATED",e["NOTIFY_PUSH"]="NOTIFY_PUSH",e["KICKED_OUT"]="KICKED_OUT",e["LOCAL_NOTIFY"]="LOCAL_NOTIFY",e["TYPING"]="TYPING",e["NOTIFY_RTC"]="NOTIFY_RTC",e["RECEPTION_CHANGE"]="RECEPTION_CHANGE",e["SESSION_START"]="SESSION_START",e["INVITE_QQ"]="INVITE_QQ",e["ADD_QQ_CARD"]="ADD_QQ_CARD",e["ERROR"]="error",e["READ_RECEIPT"]="READ_RECEIPT"})(y||(y={})),function(e){e["MSG_TEXT"]="text",e["MSG_FACE"]="face",e["MSG_MEDIA"]="media_resources",e["MSG_IMAGE"]="image",e["MSG_LONG_MSG"]="long_msg",e["MSG_IMAGE_TEXT"]="image_text",e["MSG_QDXML"]="qdxml_msg",e["MSG_FILE"]="file_info",e["MSG_VOICE"]="ptt_info",e["MSG_GRAY"]="gray_msg",e["MSG_MIX"]="mix",e["MSG_REVOKE"]="revoke_msg",e["MSG_ROBOT"]="robot",e["MSG_ROBOT_FORM"]="robot_form",e["MSG_ROBOT_NAV"]="robot_nav",e["MSG_FEED_BACK"]="feed_back",e["MSG_ROBOT_SDK"]="robot_sdk",e["MSG_THIRD_MSG"]="third_msg",e["MSG_RTC"]="rtc_msg"}(b||(b={})),function(e){e[e["OBJ_UNKNOWN"]=1]="OBJ_UNKNOWN",e[e["OBJ_IMAGE"]=2]="OBJ_IMAGE",e[e["OBJ_VOICE"]=3]="OBJ_VOICE",e[e["OBJ_FILE"]=4]="OBJ_FILE",e[e["OBJ_LONGTEXT"]=5]="OBJ_LONGTEXT",e[e["OBJ_IMGTXT"]=6]="OBJ_IMGTXT"}(v||(v={}));var x=S(),q={create:function(e,t){return e&&x.create(e),Object.assign(x.config,t),x},new:function(e,t){var n=S();return e&&n.create(e),Object.assign(n.config,t),n},EVENT:y,TYPES:b,OBJTYPES:v},O=(n("4d63"),n("c607"),n("ac1f"),n("2c3e"),n("00b4"),n("bc3a")),T=n.n(O);"undefined"!==typeof uni&&uni.request&&(T.a.defaults.adapter=function(e){return new Promise((function(t,i){var s=n("467f"),o=n("30b5"),a=new RegExp("^http(s)?://").test(e.url)?e.url:e.baseURL+e.url;uni.request({method:e.method.toUpperCase(),url:o(a,e.params,e.paramsSerializer),header:e.headers,data:e.data,dataType:e.dataType,responseType:e.responseType,sslVerify:e.sslVerify,complete:function(n){var o={data:n.data,status:n.statusCode,errMsg:n.errMsg,header:n.header,config:e};s(t,i,o)}})}))});var w=n("c7eb"),E=n("1da1"),R=(n("d9e2"),n("e060")),D={LOGIN:"/v1/interface/inner/cloudim_324034",EXIT_QUEUE:"/v1/interface/inner/txplus_214001",DOWNLOAD_COMPRESSED_COTENT:"/v1/interface/inner/cloudcc_303902",ADD_TO_CUST_BASE:"/v1/websdk/inner/txplus_100016",GET_MSG_READ_INFO_REQ:"/v1/customerService/message/c/getMsgReadInfoReq",REPORT_MSG_READ_INFO:"/v1/customerService/message/c/reportMsgReadInfo"};n("a15b"),n("5319");function I(){var e=(Math.floor(10*Math.random())||1)+C(3,10)+(new Date).getTime().toString().slice(2,13);try{if(e.length<15){var t=e;e+=C(15-e.length,10),d({module:"c-imsdk-utils",method:"[createVisitor][createAid]",message:"beforeAid:".concat(t," aid:").concat(e," time: ").concat((new Date).getTime())})}}catch(n){}return e}function N(){return"xxxxxxxxxxxxxxxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0,n="x"==e?t:3&t|8;return n.toString(16)}))}function C(e,t){var n,i,s="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),o=[];if(t=t||s.length,e)for(n=0;n<e;n++)o[n]=s[0|Math.random()*t];else for(o[8]=o[13]=o[18]=o[23]="-",o[14]="4",n=0;n<36;n++)o[n]||(i=0|16*Math.random(),o[n]=s[19==n?3&i|8:i]);return o.join("")}var A,j=n("27ae");function G(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:A.aid,t=arguments.length>1?arguments[1]:void 0,n=e;if(t)try{localStorage.setItem(n,String(t))}catch(i){}else try{return localStorage.getItem(n)||""}catch(i){return""}}(function(e){e["aid"]="qdim_v5_user_id",e["token"]="qdim_v5_token",e["uuid"]="qdim_v5_uuid"})(A||(A={}));var L=0;function P(e,t){var n=t||A;if(R["a"].inIframe()){if(e.visitorid&&(e.uuid||e.token))return console.log("wpaDetail",e.visitorid,e.uuid,e.token),{aid:e.visitorid,uuid:e.token?"":e.uuid,token:e.token?e.token:""};var i=I(),s=N();return{aid:i,uuid:s,token:""}}var o=G(n.aid),a=G(n.uuid),r=G(n.token);if(!o||!a&&!r){o=I(),a=N(),G(n.aid,o),G(n.uuid,a);try{localStorage.removeItem(n.token)}catch(_){}}return{aid:o,uuid:a,token:G(n.token)}}function U(e,t){var n=t||A,i=e.aid,s=e.d2;G(n.aid,i),G(n.token,s);try{localStorage.removeItem(n.uuid)}catch(o){}}function B(e){var t=window,n=t.Instant;n||g("Instant must be loaded!");var i=P(e.wpaDetail);L++;var o={uint32_appid:e.appid||3,uint64_kfuin:e.kfuin,bytes_custom_key:e.authType?"":j.encode(String(i.aid||"")),str_session_ticket:i&&i.aid&&i.token?i.token:"",str_client_uuid:i&&i.aid&&i.uuid?i.uuid:""};return e.authType&&(o.str_auth_info=j.encode(e.authData)),new Promise((function(t,a){var r=s["a"].getSDKDomain();T.a.post(r.api+D.LOGIN,o).then(function(){var s=Object(E["a"])(Object(w["a"])().mark((function s(o){var _,c,u,m,d,g,p,l,h,y;return Object(w["a"])().wrap((function(s){while(1)switch(s.prev=s.next){case 0:if(200!==o.status){s.next=23;break}if(_=o.data,c=_.code,u=_.data,!(0===c||L>=4&&u&&u.uint64_unique_id)){s.next=12;break}L=0,m=u.uint64_unique_id,d=j.decode(u.session_key),g=j.decode(u.session_ticket),j.decode(u.socket_address),p=u.bytes_str_user_info,m&&d&&g&&(R["a"].inIframe()?(e.wpaDetail.visitorid=m,e.wpaDetail.token=g,e.wpaDetail.uuid=i.uuid||"",window.parent.postMessage({act:"UPDATE_AUTH",data:{visitorid:m,token:g,kfuin:e.kfuin,wpaId:e.wpaDetail.wpaId}},"*")):U({aid:m,d2:g}),l=n.create({appid:3,client_type:5,kfuin:e.kfuin,aid:m,skey:"",d2:g,url:r.ws,token_type:0}),l.ready().then((function(e){f("Instant Ready",e)})),h=q.create({socketio:l},{channelType:4}),h.login({uin:m,corpUin:e.kfuin},{wpaId:e.wpaId}),y={aid:m,userInfo:p,d2:g,imsdk:h},f("[im-create-succ]",m),t(y)),s.next=21;break;case 12:try{R["a"].inIframe()||10017!==c||(localStorage.removeItem(A.aid),localStorage.removeItem(A.token),localStorage.removeItem(A.uuid)),R["a"].inIframe()&&10017===c&&(e.wpaDetail.visitorid="",e.wpaDetail.uuid="",e.wpaDetail.token="")}catch(b){}if(!(L<4)){s.next=20;break}return s.t0=t,s.next=17,B(e);case 17:return s.t1=s.sent,(0,s.t0)(s.t1),s.abrupt("return");case 20:a(new Error(o.data.message||"登录失败"));case 21:s.next=24;break;case 23:a(new Error("登录失败"));case 24:case"end":return s.stop()}}),s)})));return function(e){return s.apply(this,arguments)}}()).catch((function(){a(new Error("登录失败"))}))}))}var z=n("53ca"),F=n("27ae");function K(e,t,n){return Y.apply(this,arguments)}function Y(){return Y=Object(E["a"])(Object(w["a"])().mark((function e(t,n,i){var o,a,r,_,c,u,m,g,f,p,l;return Object(w["a"])().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return o={uint32_appid:t.appid,uint64_kfuin:t.kfuin,str_useragent:t.userAgent||"",str_extend_data:F.encode(t.extendData||"")},i&&i.authType&&i.authData&&Object.assign(o,{str_auth_info:F.encode(i.authData)}),a=i&&i.authType?V(n)?n:{}:V(n)?n:{aid:I(),uuid:N(),d2:""},Object.assign(o,{bytes_custom_key:F.encode(String(a.aid||"")),str_session_ticket:a&&a.aid&&a.d2?a.d2:"",str_client_uuid:a&&a.aid&&a.uuid?a.uuid:""}),r=s["a"].getSDKDomain(),d({module:"c-imsdk-utils",method:"[createVisitor][request]",message:o}),e.next=8,T.a.post(r.api+D.LOGIN,o);case 8:if(_=e.sent,d({module:"c-imsdk-utils",method:"[createVisitor][response]",message:_.data}),200===_.status){e.next=12;break}return e.abrupt("return",Promise.reject({code:-1,message:"network error"}));case 12:if(c=_.data,u=c.code,m=c.data,g=c.message,0===u&&m){e.next=15;break}return e.abrupt("return",Promise.reject({code:u||-2,message:g||"api error"}));case 15:if(f=m.uint64_unique_id,p=F.decode(m.session_ticket||""),l=m.bytes_str_user_info,f&&p){e.next=20;break}return e.abrupt("return",Promise.reject({code:-3,message:"data error"}));case 20:return e.abrupt("return",{aid:f,d2:p,userInfo:l});case 21:case"end":return e.stop()}}),e)}))),Y.apply(this,arguments)}function J(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.Instant,i=t.imsdk;n||(n="object"===("undefined"===typeof window?"undefined":Object(z["a"])(window))&&window.Instant),n||g("Instant must be loaded!");var o=s["a"].getSDKDomain(),a=n.create({client_type:5,token_type:0,skey:"",appid:e.appid,kfuin:e.kfuin,d2:e.d2,aid:e.aid,url:o.ws});return i||(i=q.create()),i.create({socketio:a,Instant:n}),Object.assign(i.config,{channelType:t.channelType||50,cosBucket:"undefined"!==typeof t.cosBucket?t.cosBucket:1}),i.login({uin:e.aid,corpUin:e.kfuin},{wpaId:e.wpaId}),d({module:"c-imsdk-utils",method:"[loginQDIM][done]",message:{params:e,extData:t}}),i}function Q(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.Instant,i=t.imsdk;n||(n="object"===("undefined"===typeof window?"undefined":Object(z["a"])(window))&&window.Instant),n||g("Instant must be loaded!");var o=s["a"].getSDKDomain(),a=n.newInstance({client_type:5,token_type:0,skey:"",appid:e.appid,kfuin:e.kfuin,d2:e.d2,aid:e.aid,url:o.ws});return i||(i=q.new()),i.create({socketio:a,Instant:n}),Object.assign(i.config,{channelType:t.channelType||50,cosBucket:"undefined"!==typeof t.cosBucket?t.cosBucket:1}),i.login({uin:e.aid,corpUin:e.kfuin},{wpaId:e.wpaId}),d({module:"c-imsdk-utils",method:"[newQDIM][done]",message:{params:e,extData:t}}),i}function V(e){var t=e.aid,n=e.d2,i=e.uuid;return t&&n||t&&i}n("b680"),n("2b3d"),n("bf19"),n("9861"),n("88a7"),n("271a"),n("5494");var X=n("7c8d"),H=n.n(X),W=n("27ae"),Z=q.create(),$={needCompress:!0,compressOption:{quality:.7},maxNum:5,maxSize:4194304,acceptType:["image/jpeg","image/jpg","image/bmp","image/png","image/gif"]},ee={maxNum:5,maxSize:104857600,acceptType:"*"};function te(){return 1e3*Date.now()+Math.floor(1e3*Math.random())}function ne(e){var t=1048576,n=1024;return e>=t?(e/t).toFixed(1)+"MB":e>=n?(e/n).toFixed(1)+"KB":e+"B"}function ie(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return!(e.size<=5||e.size>t.maxSize)||(g("file.size",e.size),!1)}function se(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=!1,i=t.acceptType,s=e.name.split(".");if(!i||"*"===i)return!0;for(var o=0;o<i.length;++o)if(e.type===i[o]||-1!==e.type.indexOf(i[o])||-1!==s[s.length-1].indexOf(i[o])){n=!0;break}return n}function oe(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new Promise((function(n,i){new H.a(e,{quality:t.quality||.8,success:function(e){f("[compressImg success]");var t=e;n(t)},error:function(t){f("image compress error ----\x3e>>>>",t),n(e)}})}))}function ae(e,t,n){return!1===n?{code:-10040,info:t,file:e,message:"上传失败: 网络异常"}:{code:0,info:Object(o["a"])(Object(o["a"])({},t),{},{uuid:n,path:n})}}function re(e){var t={};return t.id=te(),t.name=e.name,t.size=e.size,t.format=e.type,t.uuid="blob",t.path=URL.createObjectURL(e),new Promise((function(e,n){var i=new Image;i.src=t.path,i.onload=function(){t.width=i.naturalWidth,t.height=i.naturalHeight,e(t)},i.onerror=function(t){e(!1)}}))}function _e(e,t,n){var i=Z.createImageUploadMessage({size:t.size,name:t.name});return new Promise((function(s){d({module:"c-imsdk-utils",method:"[doUploadImage][request][sign-url]",message:i});var o=Z.sendUploadOrDownloadMessage(i);o.then((function(i){var o="https://".concat(i.host).concat(i.url);d({module:"c-imsdk-utils",method:"[doUploadImage][response][sign-url]",message:o});var a=new AbortController;T.a.put(o,e,{headers:{"Content-Type":"application/octet-stream"},withCredentials:!1,onUploadProgress:function(e){if(e){var i=e.loaded/e.total;f("[onUploadProgress]",i),n&&"function"===typeof n.onProgress&&n.onProgress(t,i,a)}},signal:a.signal}).then((function(e){d({module:"c-imsdk-utils",method:"[doUploadImage][response][upload]",message:e.status}),200===e.status?s(i.uuid):s(!1)})).catch((function(){d({module:"c-imsdk-utils",method:"[doUploadImage][error][upload]",message:o}),s(!1)}))})).catch((function(){d({module:"c-imsdk-utils",method:"[doUploadImage][error][sign-url]",message:i}),s(!1)}))}))}function ce(e){return ue.apply(this,arguments)}function ue(){return ue=Object(E["a"])(Object(w["a"])().mark((function e(t){var n,i,s,a,r,_,c,u,m,d,g=arguments;return Object(w["a"])().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(n=g.length>1&&void 0!==g[1]?g[1]:null,i=g.length>2&&void 0!==g[2]?g[2]:{},s="图片",!n){e.next=8;break}return e.next=6,_e(t,n,i);case 6:return a=e.sent,e.abrupt("return",ae(t,n,a));case 8:if(r=Object(o["a"])(Object(o["a"])({},$.compressOption),i.compressOption),_=Object(o["a"])(Object(o["a"])(Object(o["a"])({},$),i),{},{compressOption:r}),c=se(t,_),!1!==c){e.next=13;break}return e.abrupt("return",{code:-10010,message:"不支持的".concat(s,"格式").concat(t.type?"："+t.type:"")});case 13:if(!(_.needCompress&&_.maxSize&&t.size>_.maxSize)){e.next=17;break}return e.next=16,oe(t,_.compressOption);case 16:t=e.sent;case 17:if(u=ie(t,_),!1!==u){e.next=20;break}return e.abrupt("return",{code:-10020,message:"发送".concat(s,"大小超出限制(5B~").concat(ne(_.maxSize),")")});case 20:return e.next=22,re(t);case 22:if(m=e.sent,!1!==m){e.next=25;break}return e.abrupt("return",{code:-10030,message:"".concat(s,"上传失败: 读取失败")});case 25:return"function"===typeof _.onPreview&&_.onPreview(m),e.next=28,_e(t,m,i);case 28:return d=e.sent,e.abrupt("return",ae(t,m,d));case 30:case"end":return e.stop()}}),e)}))),ue.apply(this,arguments)}function me(e){var t={};return t.id=te(),t.name=e.name,t.size=e.size,t.format=e.type,t.uuid="blob",t.path=URL.createObjectURL(e),t}function de(e,t,n){var i=Z.createFileUploadMessage({size:t.size,name:t.name},!!t.objType&&t.objType);return new Promise((function(s,o){d({module:"c-imsdk-utils",method:"[doUploadFile][request][sign-url]",message:i});var a=Z.sendUploadOrDownloadMessage(i);a.then((function(i){var o="https://".concat(i.host).concat(i.url);d({module:"c-imsdk-utils",method:"[doUploadFile][response][sign-url]",message:o});var a=new AbortController;T.a.put(o,e,{headers:{"Content-Type":"application/octet-stream"},withCredentials:!1,onUploadProgress:function(e){if(e){var i=e.loaded/e.total;f("[onUploadProgress]",i),n&&"function"===typeof n.onProgress&&n.onProgress(t,i,a)}},signal:a.signal}).then((function(e){d({module:"c-imsdk-utils",method:"[doUploadFile][response][upload]",message:e}),200===e.status?s(i.uuid):s(!1)})).catch((function(){d({module:"c-imsdk-utils",method:"[doUploadFile][error][upload]",message:o}),s(!1)}))})).catch((function(){d({module:"c-imsdk-utils",method:"[doUploadFile][error][sign-url]",message:i}),s(!1)}))}))}function ge(e){return fe.apply(this,arguments)}function fe(){return fe=Object(E["a"])(Object(w["a"])().mark((function e(t){var n,i,s,o,a,r,_,c,u,m=arguments;return Object(w["a"])().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(n=m.length>1&&void 0!==m[1]?m[1]:null,i=m.length>2&&void 0!==m[2]?m[2]:{},s="文件",!n){e.next=8;break}return e.next=6,de(t,n,i);case 6:return o=e.sent,e.abrupt("return",ae(t,n,o));case 8:if(a=Object.assign(ee,i),r=se(t,a),!1!==r){e.next=12;break}return e.abrupt("return",{code:-10010,message:"不支持的".concat(s,"格式").concat(t.type?"："+t.type:"")});case 12:if(_=ie(t,a),!1!==_){e.next=15;break}return e.abrupt("return",{code:-10020,message:"发送".concat(s,"大小超出限制(5B~").concat(ne(a.maxSize),")")});case 15:return e.next=17,me(t);case 17:return c=e.sent,"function"===typeof a.onPreview&&a.onPreview(c),e.next=21,de(t,c,i);case 21:return u=e.sent,e.abrupt("return",ae(t,c,u));case 23:case"end":return e.stop()}}),e)}))),fe.apply(this,arguments)}function pe(e,t){var n={};return n.id=te(),n.name=e.name||"voice.amr",n.size=e.size,n.format=e.type,n.uuid="blob",n.path=URL.createObjectURL(e),n.length=t.voiceLength,n}function le(e,t,n){return de(e,Object.assign({},t,{objType:q.OBJTYPES.OBJ_VOICE}),n)}function he(e){return ye.apply(this,arguments)}function ye(){return ye=Object(E["a"])(Object(w["a"])().mark((function e(t){var n,i,s,o,a,r=arguments;return Object(w["a"])().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(n=r.length>1&&void 0!==r[1]?r[1]:null,i=r.length>2&&void 0!==r[2]?r[2]:{},"语音",!n){e.next=8;break}return e.next=6,le(t,n,i);case 6:return s=e.sent,e.abrupt("return",ae(t,n,s));case 8:return e.next=10,pe(t,{voiceLength:i.voiceLength});case 10:return o=e.sent,"function"===typeof i.onPreview&&i.onPreview(o),e.next=14,le(t,o,i);case 14:return a=e.sent,e.abrupt("return",ae(t,o,a));case 16:case"end":return e.stop()}}),e)}))),ye.apply(this,arguments)}function be(e){var t=Z.createFileUploadMessage({},q.OBJTYPES.OBJ_LONGTEXT);return new Promise((function(n,i){Z.sendUploadOrDownloadMessage(t).then((function(t){var i="https://".concat(t.host).concat(t.url);T.a.put(i,e,{headers:{"Content-Type":"application/octet-stream"},withCredentials:!1}).then((function(e){200===e.status?n({code:0,info:{uuid:t.uuid}}):n({code:e.status,message:"上传失败"})})).catch((function(e){n({code:-1,message:"上传失败"})}))})).catch((function(e){n({code:-1,message:"上传失败"})}))}))}function ve(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;if(n===q.OBJTYPES.OBJ_IMAGE?t=Z.createImageDownloadMessage(e):n===q.OBJTYPES.OBJ_FILE||n===q.OBJTYPES.OBJ_VOICE?t=Z.createFileDownloadMessage(e):n===q.OBJTYPES.OBJ_LONGTEXT&&(t=Z.createFileDownloadMessage(e,q.OBJTYPES.OBJ_LONGTEXT)),!t)return g("[getDownloadUrl] type error",n),Promise.resolve("");var i=Z.sendUploadOrDownloadMessage(t);return new Promise((function(e){i.then((function(t){var n="https://".concat(t.host).concat(t.url);e(n)})).catch((function(){e("")}))}))}function ke(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"txt",n=Z.createCompressedLongTextDownloadMessage(e,t);return new Promise((function(e,t){var i=s["a"].getSDKDomain();T.a.post(i.api+D.DOWNLOAD_COMPRESSED_COTENT,n).then((function(n){if(200===n.status){var i=n.data,s=i.code,o=i.data;if(!s){var a=o.long_msg_info||o.struct_msg_info;e(a.str_content)}}t(!1)})).catch((function(e){g("[downloadAndParseLongText]",e),t(!1)}))}))}function Me(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"txt",n=Z.createCompressedSDKLongTextDownloadMessage(e,t);return new Promise((function(e,t){var i=s["a"].getSDKDomain();T.a.post(i.api+D.DOWNLOAD_COMPRESSED_COTENT,n).then((function(n){if(200===n.status){var i=n.data,s=i.code,o=i.data;if(!s){var a=o.long_msg_info||o.struct_msg_info;e(a.str_content)}}t(!1)})).catch((function(e){g("[downloadAndParseLongText]",e),t(!1)}))}))}function Se(e){d({module:"c-imsdk-utils",method:"exitQueue",message:e});var t=s["a"].getSDKDomain(),n=Z.createExitQueueMessage(e);return T.a.post(t.api+D.EXIT_QUEUE,n)}function xe(e){d({module:"c-imsdk-utils",method:"getMessageReadReceipt",message:e});var t=s["a"].getSDKDomain(),n=Oe(),i=Z.createGetMsgReadInfoReq(e);return T.a.post(t.api+D.GET_MSG_READ_INFO_REQ,i,{headers:n})}function qe(e){d({module:"c-imsdk-utils",method:"setMessageReadReceipt",message:e});var t=s["a"].getSDKDomain(),n=Oe(),i=Z.createReportMsgReadReportReq(e);return T.a.post(t.api+D.REPORT_MSG_READ_INFO,i,{headers:n})}function Oe(){var e=Z.getConnectConfig(),t=e.appid,n=e.kfuin,i=e.aid,s=e.d2;return{"X-Appid":t,"X-Aid":i,"X-D2":s,"X-Tenant-Id":n}}function Te(e){Z=e}function we(e){var t=s["a"].getSDKDomain(),n=Oe(),i={uint32_source:e.source||150,bytes_cid:W.encode(e.cid),uint64_extuin:0};return T.a.post(t.api+D.ADD_TO_CUST_BASE,i,{headers:n})}}}]);
//# sourceMappingURL=chunk-imsdk.ae0a9363.js.map